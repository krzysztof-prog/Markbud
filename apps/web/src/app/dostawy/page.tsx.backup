'use client';

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Header } from '@/components/layout/header';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { deliveriesApi } from '@/lib/api';
import { formatDate } from '@/lib/utils';
import { OrderDetailModal } from '@/components/orders/order-detail-modal';
import {
  ChevronLeft,
  ChevronRight,
  Plus,
  Package,
  Truck,
  Trash2,
  X,
  ArrowRight,
  Eye,
  Calendar,
  CheckCircle2,
} from 'lucide-react';

interface Delivery {
  id: number;
  deliveryDate: string;
  deliveryNumber: string | null;
  status: string;
  totalWindows: number | null;
  notes: string | null;
  deliveryOrders: {
    order: {
      id: number;
      orderNumber: string;
      totalWindows: number | null;
      totalSashes: number | null;
      totalGlasses: number | null;
    };
  }[];
  deliveryItems?: {
    id: number;
    itemType: string;
    description: string;
    quantity: number;
  }[];
}

export default function DostawyPage() {
  const queryClient = useQueryClient();
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDelivery, setSelectedDelivery] = useState<Delivery | null>(null);
  const [showNewDeliveryDialog, setShowNewDeliveryDialog] = useState(false);
  const [newDeliveryDate, setNewDeliveryDate] = useState('');
  const [newDeliveryNumber, setNewDeliveryNumber] = useState('');
  const [newDeliveryNotes, setNewDeliveryNotes] = useState('');
  const [showDeleteConfirm, setShowDeleteConfirm] = useState<number | null>(null);
  const [orderToAssign, setOrderToAssign] = useState<{ id: number; orderNumber: string } | null>(null);
  const [selectedOrderId, setSelectedOrderId] = useState<number | null>(null);
  const [selectedOrderNumber, setSelectedOrderNumber] = useState<string | null>(null);
  const [showAddItemDialog, setShowAddItemDialog] = useState(false);
  const [newItem, setNewItem] = useState({ itemType: 'glass', description: '', quantity: 1 });
  const [showCompleteDialog, setShowCompleteDialog] = useState(false);
  const [productionDate, setProductionDate] = useState('');

  const month = currentDate.getMonth() + 1;
  const year = currentDate.getFullYear();

  const { data, isLoading } = useQuery({
    queryKey: ['deliveries-calendar', month, year],
    queryFn: () => deliveriesApi.getCalendar(month, year),
  });

  const deliveries = data?.deliveries || [];
  const unassignedOrders = data?.unassignedOrders || [];

  // Mutations
  const createDeliveryMutation = useMutation({
    mutationFn: (data: { deliveryDate: string; deliveryNumber?: string; notes?: string }) =>
      deliveriesApi.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries-calendar'] });
      setShowNewDeliveryDialog(false);
      setNewDeliveryDate('');
      setNewDeliveryNumber('');
      setNewDeliveryNotes('');
    },
  });

  const deleteDeliveryMutation = useMutation({
    mutationFn: (id: number) => deliveriesApi.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries-calendar'] });
      setSelectedDelivery(null);
      setShowDeleteConfirm(null);
    },
  });

  const removeOrderFromDeliveryMutation = useMutation({
    mutationFn: ({ deliveryId, orderId }: { deliveryId: number; orderId: number }) =>
      deliveriesApi.removeOrder(deliveryId, orderId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries-calendar'] });
    },
  });

  const addOrderToDeliveryMutation = useMutation({
    mutationFn: ({ deliveryId, orderId }: { deliveryId: number; orderId: number }) =>
      deliveriesApi.addOrder(deliveryId, orderId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries-calendar'] });
      setOrderToAssign(null);
    },
  });

  const addItemMutation = useMutation({
    mutationFn: (data: { deliveryId: number; itemType: string; description: string; quantity: number }) =>
      deliveriesApi.addItem(data.deliveryId, {
        itemType: data.itemType,
        description: data.description,
        quantity: data.quantity,
      }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries-calendar'] });
      setShowAddItemDialog(false);
      setNewItem({ itemType: 'glass', description: '', quantity: 1 });
    },
  });

  const deleteItemMutation = useMutation({
    mutationFn: ({ deliveryId, itemId }: { deliveryId: number; itemId: number }) =>
      deliveriesApi.deleteItem(deliveryId, itemId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries-calendar'] });
    },
  });

  const completeOrdersMutation = useMutation({
    mutationFn: ({ deliveryId, productionDate }: { deliveryId: number; productionDate: string }) =>
      deliveriesApi.completeOrders(deliveryId, productionDate),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries-calendar'] });
      setShowCompleteDialog(false);
      setProductionDate('');
      setSelectedDelivery(null);
    },
  });

  // Generuj dni miesiąca
  const daysInMonth = new Date(year, month, 0).getDate();
  const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
  const adjustedFirstDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

  const days: (number | null)[] = [];
  for (let i = 0; i < adjustedFirstDay; i++) {
    days.push(null);
  }
  for (let i = 1; i <= daysInMonth; i++) {
    days.push(i);
  }

  const prevMonth = () => {
    setCurrentDate(new Date(year, month - 2, 1));
  };

  const nextMonth = () => {
    setCurrentDate(new Date(year, month, 1));
  };

  const getDeliveriesForDay = (day: number) => {
    return deliveries.filter((d: Delivery) => {
      const deliveryDate = new Date(d.deliveryDate);
      return (
        deliveryDate.getDate() === day &&
        deliveryDate.getMonth() + 1 === month &&
        deliveryDate.getFullYear() === year
      );
    });
  };

  const handleCreateDelivery = () => {
    if (!newDeliveryDate) return;
    createDeliveryMutation.mutate({
      deliveryDate: newDeliveryDate,
      deliveryNumber: newDeliveryNumber || undefined,
      notes: newDeliveryNotes || undefined,
    });
  };

  // Oblicz statystyki dla danego dnia
  const getDayStats = (day: number) => {
    const dayDeliveries = getDeliveriesForDay(day);
    let windows = 0;
    let sashes = 0;
    let glasses = 0;

    dayDeliveries.forEach((delivery: Delivery) => {
      delivery.deliveryOrders.forEach((dOrder) => {
        windows += dOrder.order.totalWindows || 0;
        sashes += dOrder.order.totalSashes || 0;
        glasses += dOrder.order.totalGlasses || 0;
      });
    });

    return { windows, sashes, glasses };
  };

  // Oblicz statystyki dla tygodnia (7 dni zaczynając od podanego indeksu)
  const getWeekStats = (startIndex: number) => {
    let windows = 0;
    let sashes = 0;
    let glasses = 0;

    for (let i = startIndex; i < startIndex + 7 && i < days.length; i++) {
      const day = days[i];
      if (day !== null) {
        const dayStats = getDayStats(day);
        windows += dayStats.windows;
        sashes += dayStats.sashes;
        glasses += dayStats.glasses;
      }
    }

    return { windows, sashes, glasses };
  };

  const handleDayClick = (day: number) => {
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    setNewDeliveryDate(dateStr);
    setShowNewDeliveryDialog(true);
  };

  const monthNames = [
    'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
    'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
  ];

  const dayNames = ['Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob', 'Niedz'];

  return (
    <div className="flex flex-col h-full">
      <Header title="Dostawy" />

      <div className="flex flex-1 overflow-hidden">
        {/* Kalendarz */}
        <div className="flex-1 p-6 overflow-auto">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <div className="flex items-center gap-4">
                <Button variant="outline" size="icon" onClick={prevMonth}>
                  <ChevronLeft className="h-4 w-4" />
                </Button>
                <CardTitle>
                  {monthNames[month - 1]} {year}
                </CardTitle>
                <Button variant="outline" size="icon" onClick={nextMonth}>
                  <ChevronRight className="h-4 w-4" />
                </Button>
              </div>
              <Button onClick={() => setShowNewDeliveryDialog(true)}>
                <Plus className="h-4 w-4 mr-2" />
                Nowa dostawa
              </Button>
            </CardHeader>
            <CardContent>
              {isLoading ? (
                <div className="flex items-center justify-center h-96">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
                </div>
              ) : (
                <div className="grid grid-cols-8 gap-1">
                  {/* Nagłówki dni + kolumna statystyk */}
                  {dayNames.map((day) => (
                    <div
                      key={day}
                      className="text-center text-sm font-medium text-slate-500 py-2"
                    >
                      {day}
                    </div>
                  ))}
                  <div className="text-center text-sm font-medium text-slate-500 py-2 bg-blue-50">
                    Tydzień
                  </div>

                  {/* Dni + statystyki tygodniowe */}
                  {days.map((day, index) => {
                    const elements = [];

                    // Dodaj dzień
                    if (day === null) {
                      elements.push(<div key={`empty-${index}`} className="h-36 bg-slate-50" />);
                    } else {
                      const dayDeliveries = getDeliveriesForDay(day);
                      const dayStats = getDayStats(day);
                      const isToday =
                        day === new Date().getDate() &&
                        month === new Date().getMonth() + 1 &&
                        year === new Date().getFullYear();
                      const isWeekend = (index % 7 === 5) || (index % 7 === 6);

                      elements.push(
                        <div
                          key={day}
                          className={`h-36 border rounded-lg p-2 cursor-pointer transition-colors ${
                            isToday
                              ? 'border-blue-500 bg-blue-50 hover:bg-blue-100'
                              : isWeekend
                              ? 'bg-slate-50 hover:bg-slate-100'
                              : 'bg-white hover:bg-slate-50'
                          }`}
                          onClick={() => handleDayClick(day)}
                        >
                          <div className="flex justify-between items-start mb-1">
                            <span
                              className={`text-sm font-medium ${
                                isToday ? 'text-blue-600' : 'text-slate-700'
                              }`}
                            >
                              {day}
                            </span>
                            {dayDeliveries.length > 0 && (
                              <Badge variant="default" className="text-xs">
                                {dayDeliveries.length}
                              </Badge>
                            )}
                          </div>
                          {dayStats.windows > 0 && (
                            <div className="text-xs text-slate-600 mb-1 flex gap-2">
                              <span>O:{dayStats.windows}</span>
                              <span>S:{dayStats.sashes}</span>
                              <span>Sz:{dayStats.glasses}</span>
                            </div>
                          )}
                          <div className="space-y-1 overflow-y-auto max-h-16">
                            {dayDeliveries.map((delivery: Delivery) => (
                              <div
                                key={delivery.id}
                                className="text-xs p-1.5 rounded bg-blue-100 text-blue-800 cursor-pointer hover:bg-blue-200"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setSelectedDelivery(delivery);
                                }}
                              >
                                <div className="flex items-center gap-1">
                                  <Truck className="h-3 w-3" />
                                  <span>
                                    {delivery.deliveryNumber ? `${delivery.deliveryNumber} - ` : ''}
                                    {delivery.deliveryOrders?.length || 0} zl.
                                  </span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    }

                    // Dodaj statystyki tygodniowe po każdej niedzieli (co 7. element, index % 7 === 6)
                    if ((index + 1) % 7 === 0) {
                      const weekStartIndex = index - 6;
                      const weekStats = getWeekStats(weekStartIndex);

                      elements.push(
                        <div
                          key={`week-${index}`}
                          className="h-36 border-2 border-blue-200 rounded-lg p-2 bg-blue-50"
                        >
                          <div className="text-xs font-semibold text-blue-700 mb-2 text-center">
                            Podsumowanie
                          </div>
                          {weekStats.windows > 0 ? (
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between items-center">
                                <span className="text-slate-600">Okna:</span>
                                <span className="font-bold text-blue-700">{weekStats.windows}</span>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-slate-600">Skrzydła:</span>
                                <span className="font-bold text-blue-700">{weekStats.sashes}</span>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-slate-600">Szyby:</span>
                                <span className="font-bold text-blue-700">{weekStats.glasses}</span>
                              </div>
                            </div>
                          ) : (
                            <div className="text-xs text-slate-400 text-center mt-4">
                              Brak dostaw
                            </div>
                          )}
                        </div>
                      );
                    }

                    return elements;
                  })}
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Sidebar - zlecenia bez daty lub szczegóły dostawy */}
        <div className="w-80 border-l bg-white overflow-y-auto">
          {selectedDelivery ? (
            <div className="p-4">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold">Szczegóły dostawy</h3>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => setSelectedDelivery(null)}
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>

              <div className="space-y-4">
                <div>
                  <p className="text-sm text-slate-500">Data</p>
                  <p className="font-medium">{formatDate(selectedDelivery.deliveryDate)}</p>
                </div>

                <div>
                  <p className="text-sm text-slate-500">Status</p>
                  <Badge variant={selectedDelivery.status === 'completed' ? 'success' : 'secondary'}>
                    {selectedDelivery.status === 'planned' ? 'Zaplanowana' :
                     selectedDelivery.status === 'in_progress' ? 'W trakcie' :
                     selectedDelivery.status === 'completed' ? 'Zrealizowana' : selectedDelivery.status}
                  </Badge>
                </div>

                {selectedDelivery.notes && (
                  <div>
                    <p className="text-sm text-slate-500">Notatki</p>
                    <p className="text-sm">{selectedDelivery.notes}</p>
                  </div>
                )}

                {selectedDelivery.deliveryNumber && (
                  <div>
                    <p className="text-sm text-slate-500">Numer dostawy</p>
                    <p className="font-medium text-lg">{selectedDelivery.deliveryNumber}</p>
                  </div>
                )}

                <div>
                  <p className="text-sm text-slate-500 mb-2">
                    Zlecenia ({selectedDelivery.deliveryOrders?.length || 0})
                  </p>
                  {selectedDelivery.deliveryOrders?.length > 0 ? (
                    <div className="space-y-2">
                      {selectedDelivery.deliveryOrders.map((item) => (
                        <div
                          key={item.order.id}
                          className="flex items-center justify-between p-2 rounded bg-slate-50 hover:bg-slate-100"
                        >
                          <button
                            onClick={() => {
                              setSelectedOrderId(item.order.id);
                              setSelectedOrderNumber(item.order.orderNumber);
                            }}
                            className="font-mono text-sm text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1"
                          >
                            <Eye className="h-3 w-3" />
                            {item.order.orderNumber}
                          </button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() =>
                              removeOrderFromDeliveryMutation.mutate({
                                deliveryId: selectedDelivery.id,
                                orderId: item.order.id,
                              })
                            }
                          >
                            <X className="h-4 w-4 text-red-500" />
                          </Button>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-slate-400">Brak zleceń</p>
                  )}
                </div>

                <div>
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-sm text-slate-500">
                      Dodatkowe artykuły ({selectedDelivery.deliveryItems?.length || 0})
                    </p>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => setShowAddItemDialog(true)}
                      className="h-6 px-2"
                    >
                      <Plus className="h-3 w-3" />
                    </Button>
                  </div>
                  {selectedDelivery.deliveryItems && selectedDelivery.deliveryItems.length > 0 ? (
                    <div className="space-y-2">
                      {selectedDelivery.deliveryItems.map((item) => (
                        <div
                          key={item.id}
                          className="flex items-center justify-between p-2 rounded bg-green-50 text-sm"
                        >
                          <div>
                            <span className="font-medium">{item.quantity}x</span>{' '}
                            <span className="text-slate-600">{item.description}</span>
                            <Badge variant="outline" className="ml-2 text-xs">
                              {item.itemType === 'glass' ? 'Szyby' :
                               item.itemType === 'sash' ? 'Skrzydła' :
                               item.itemType === 'frame' ? 'Ramy' : 'Inne'}
                            </Badge>
                          </div>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() =>
                              deleteItemMutation.mutate({
                                deliveryId: selectedDelivery.id,
                                itemId: item.id,
                              })
                            }
                          >
                            <X className="h-4 w-4 text-red-500" />
                          </Button>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-slate-400">Brak dodatkowych artykułów</p>
                  )}
                </div>

                <div className="pt-4 border-t space-y-2">
                  {selectedDelivery.deliveryOrders && selectedDelivery.deliveryOrders.length > 0 && (
                    <Button
                      variant="default"
                      size="sm"
                      className="w-full"
                      onClick={() => setShowCompleteDialog(true)}
                    >
                      <CheckCircle2 className="h-4 w-4 mr-2" />
                      Zlecenia zakończone
                    </Button>
                  )}
                  <Button
                    variant="destructive"
                    size="sm"
                    className="w-full"
                    onClick={() => setShowDeleteConfirm(selectedDelivery.id)}
                  >
                    <Trash2 className="h-4 w-4 mr-2" />
                    Usuń dostawę
                  </Button>
                </div>
              </div>
            </div>
          ) : (
            <div className="p-4">
              <h3 className="font-semibold text-sm text-slate-500 uppercase tracking-wide mb-3 flex items-center gap-2">
                <Package className="h-4 w-4" />
                Zlecenia bez daty
              </h3>
              <p className="text-xs text-slate-400 mb-4">
                Kliknij na dzień w kalendarzu, aby utworzyć dostawę
              </p>

              {unassignedOrders.length > 0 ? (
                <div className="space-y-2">
                  {unassignedOrders.map((order: any) => (
                    <div
                      key={order.id}
                      className="p-3 rounded-lg border bg-slate-50"
                    >
                      <div className="flex items-center justify-between">
                        <span className="font-mono font-medium">{order.orderNumber}</span>
                        <Badge variant="outline" className="text-xs">
                          {order.status === 'new' ? 'Nowe' :
                           order.status === 'in_progress' ? 'W realizacji' :
                           order.status === 'ready' ? 'Gotowe' : order.status}
                        </Badge>
                      </div>
                      {order.deliveryDate && (
                        <p className="text-xs text-slate-500 mt-1">
                          Planowana: {formatDate(order.deliveryDate)}
                        </p>
                      )}
                      <Button
                        variant="outline"
                        size="sm"
                        className="w-full mt-2"
                        onClick={() => setOrderToAssign({ id: order.id, orderNumber: order.orderNumber })}
                      >
                        <ArrowRight className="h-3 w-3 mr-1" />
                        Dodaj do dostawy
                      </Button>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-sm text-slate-400 text-center py-8">
                  Wszystkie zlecenia mają przypisaną datę dostawy
                </p>
              )}
            </div>
          )}
        </div>
      </div>

      {/* Dialog: Nowa dostawa */}
      <Dialog open={showNewDeliveryDialog} onOpenChange={setShowNewDeliveryDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Nowa dostawa</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div>
              <label className="text-sm font-medium block mb-1">Data dostawy</label>
              <Input
                type="date"
                value={newDeliveryDate}
                onChange={(e) => setNewDeliveryDate(e.target.value)}
              />
            </div>
            <div>
              <label className="text-sm font-medium block mb-1">Numer dostawy (opcjonalne)</label>
              <select
                className="w-full border rounded-md px-3 py-2 text-sm"
                value={newDeliveryNumber}
                onChange={(e) => setNewDeliveryNumber(e.target.value)}
              >
                <option value="">Brak</option>
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III">III</option>
              </select>
            </div>
            <div>
              <label className="text-sm font-medium block mb-1">Notatki (opcjonalne)</label>
              <Input
                value={newDeliveryNotes}
                onChange={(e) => setNewDeliveryNotes(e.target.value)}
                placeholder="np. Transport własny"
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowNewDeliveryDialog(false)}>
              Anuluj
            </Button>
            <Button
              onClick={handleCreateDelivery}
              disabled={!newDeliveryDate || createDeliveryMutation.isPending}
            >
              Utwórz
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog: Potwierdzenie usunięcia */}
      <Dialog open={!!showDeleteConfirm} onOpenChange={(open) => !open && setShowDeleteConfirm(null)}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Potwierdź usunięcie</DialogTitle>
          </DialogHeader>
          <p className="py-4">
            Czy na pewno chcesz usunąć tę dostawę? Tej operacji nie można cofnąć.
          </p>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowDeleteConfirm(null)}>
              Anuluj
            </Button>
            <Button
              variant="destructive"
              onClick={() => showDeleteConfirm && deleteDeliveryMutation.mutate(showDeleteConfirm)}
              disabled={deleteDeliveryMutation.isPending}
            >
              Usuń
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog: Dodaj zlecenie do dostawy */}
      <Dialog open={!!orderToAssign} onOpenChange={(open) => !open && setOrderToAssign(null)}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Dodaj zlecenie do dostawy</DialogTitle>
          </DialogHeader>
          <div className="py-4">
            <p className="text-sm text-slate-500 mb-4">
              Wybierz dostawę dla zlecenia <span className="font-mono font-medium">{orderToAssign?.orderNumber}</span>:
            </p>
            {deliveries.length > 0 ? (
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {deliveries.map((delivery: Delivery) => (
                  <button
                    key={delivery.id}
                    className="w-full p-3 rounded-lg border bg-slate-50 hover:bg-blue-50 hover:border-blue-300 transition-colors text-left"
                    onClick={() => {
                      if (orderToAssign) {
                        addOrderToDeliveryMutation.mutate({
                          deliveryId: delivery.id,
                          orderId: orderToAssign.id,
                        });
                      }
                    }}
                    disabled={addOrderToDeliveryMutation.isPending}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Truck className="h-4 w-4 text-blue-500" />
                        <span className="font-medium">{formatDate(delivery.deliveryDate)}</span>
                      </div>
                      <Badge variant="outline" className="text-xs">
                        {delivery.deliveryOrders?.length || 0} zleceń
                      </Badge>
                    </div>
                    {delivery.notes && (
                      <p className="text-xs text-slate-500 mt-1 ml-6">{delivery.notes}</p>
                    )}
                  </button>
                ))}
              </div>
            ) : (
              <p className="text-sm text-slate-400 text-center py-4">
                Brak dostaw w tym miesiącu. Utwórz nową dostawę klikając na dzień w kalendarzu.
              </p>
            )}
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setOrderToAssign(null)}>
              Anuluj
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog: Dodaj artykuł */}
      <Dialog open={showAddItemDialog} onOpenChange={setShowAddItemDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Dodaj dodatkowy artykuł</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div>
              <label className="text-sm font-medium block mb-1">Typ artykułu</label>
              <select
                className="w-full border rounded-md px-3 py-2 text-sm"
                value={newItem.itemType}
                onChange={(e) => setNewItem({ ...newItem, itemType: e.target.value })}
              >
                <option value="glass">Szyby</option>
                <option value="sash">Skrzydła</option>
                <option value="frame">Ramy</option>
                <option value="other">Inne</option>
              </select>
            </div>
            <div>
              <label className="text-sm font-medium block mb-1">Opis</label>
              <Input
                value={newItem.description}
                onChange={(e) => setNewItem({ ...newItem, description: e.target.value })}
                placeholder="np. Szyby hartowane 6mm"
              />
            </div>
            <div>
              <label className="text-sm font-medium block mb-1">Ilość</label>
              <Input
                type="number"
                min="1"
                value={newItem.quantity}
                onChange={(e) => setNewItem({ ...newItem, quantity: parseInt(e.target.value) || 1 })}
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowAddItemDialog(false)}>
              Anuluj
            </Button>
            <Button
              onClick={() => {
                if (selectedDelivery && newItem.description) {
                  addItemMutation.mutate({
                    deliveryId: selectedDelivery.id,
                    ...newItem,
                  });
                }
              }}
              disabled={!newItem.description || addItemMutation.isPending}
            >
              Dodaj
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog: Zlecenia zakończone */}
      <Dialog open={showCompleteDialog} onOpenChange={setShowCompleteDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Oznacz zlecenia jako zakończone</DialogTitle>
          </DialogHeader>
          <div className="py-4">
            <p className="text-sm text-slate-500 mb-4">
              Wszystkie zlecenia z tej dostawy zostaną oznaczone jako wyprodukowane z podaną datą.
            </p>
            <div>
              <label className="text-sm font-medium block mb-1">Data wyprodukowania</label>
              <Input
                type="date"
                value={productionDate}
                onChange={(e) => setProductionDate(e.target.value)}
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowCompleteDialog(false)}>
              Anuluj
            </Button>
            <Button
              onClick={() => {
                if (selectedDelivery && productionDate) {
                  completeOrdersMutation.mutate({
                    deliveryId: selectedDelivery.id,
                    productionDate,
                  });
                }
              }}
              disabled={!productionDate || completeOrdersMutation.isPending}
            >
              Zakończ zlecenia
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Modal podglądu zlecenia */}
      <OrderDetailModal
        orderId={selectedOrderId}
        orderNumber={selectedOrderNumber || undefined}
        open={!!selectedOrderId}
        onOpenChange={(open) => {
          if (!open) {
            setSelectedOrderId(null);
            setSelectedOrderNumber(null);
          }
        }}
      />
    </div>
  );
}
