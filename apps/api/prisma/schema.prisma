generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// SQLite nie obs≈Çuguje enum√≥w - walidacja odbywa siƒô na poziomie aplikacji (Zod)
// Dostƒôpne role: owner | admin | kierownik | ksiegowa | user

model User {
  id                        Int                     @id @default(autoincrement())
  email                     String                  @unique
  passwordHash              String                  @map("password_hash")
  name                      String
  role                      String                  @default("user") // owner | admin | kierownik | ksiegowa | user
  createdAt                 DateTime                @default(now()) @map("created_at")
  updatedAt                 DateTime                @updatedAt @map("updated_at")
  deletedAt                 DateTime?               @map("deleted_at") // Soft delete - data usuniƒôcia u≈ºytkownika
  notes                     Note[]
  warehouseHistory          WarehouseHistory[]      @relation("RecordedBy")
  warehouseOrdersCreated    WarehouseOrder[]        @relation("WarehouseOrderCreatedBy")
  warehouseUpdates          WarehouseStock[]        @relation("UpdatedBy")
  folderSettings            UserFolderSettings?
  importLocks               ImportLock[]
  // DualStock (Okuc) relations
  okucStockUpdates          OkucStock[]             @relation("OkucStockUpdatedBy")
  okucOrdersCreated         OkucOrder[]             @relation("OkucOrderCreatedBy")
  okucHistoryRecorded       OkucHistory[]           @relation("OkucHistoryRecordedBy")
  okucHistoryEdited         OkucHistory[]           @relation("OkucHistoryEditedBy")
  // ProductionReport relations
  closedProductionReports   ProductionReport[]      @relation("ProductionReportClosedBy")
  reopenedProductionReports ProductionReport[]      @relation("ProductionReportReopenedBy")
  // DocumentAuthor relations
  ordersAsDocumentAuthor    Order[]                 @relation("OrderDocumentAuthor")
  authorMappings            DocumentAuthorMapping[]
  // PendingImportConflict relations
  importConflictsAsAuthor   PendingImportConflict[] @relation("ConflictAuthor")
  importConflictsResolved   PendingImportConflict[] @relation("ConflictResolver")
  // Steel module relations
  steelStockUpdates         SteelStock[]            @relation("SteelStockUpdatedBy")
  steelOrdersCreated        SteelOrder[]            @relation("SteelOrderCreatedBy")
  steelHistoryRecorded      SteelHistory[]          @relation("SteelHistoryRecordedBy")
  // Pallet initial stock relations
  palletInitialStockUpdates PalletInitialStock[]    @relation("PalletInitialStockUpdatedBy")
  // Logistics decision logs
  logisticsDecisionLogs     LogisticsDecisionLog[]
  // Orders deleted by this user
  deletedOrders             Order[]                 @relation("OrderDeletedBy")

  @@map("users")
}

// Mapowanie nazw autor√≥w dokument√≥w z CSV na u≈ºytkownik√≥w systemu
model DocumentAuthorMapping {
  id         Int      @id @default(autoincrement())
  authorName String   @unique @map("author_name") // Nazwa autora z CSV (np. "Wlodek", "Arek", "Krzysztof")
  userId     Int      @map("user_id") // ID u≈ºytkownika systemu
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("document_author_mappings")
}

model Profile {
  id                  Int                  @id @default(autoincrement())
  number              String               @unique
  articleNumber       String?              @unique @map("article_number")
  name                String
  description         String?
  sortOrder           Int                  @default(0) @map("sort_order")
  isAkrobud           Boolean              @default(false) @map("is_akrobud") // Czy pokazywaƒá w magazynie Akrobud
  // Systemy profilowe - do kt√≥rych system√≥w pasuje profil
  isLiving            Boolean              @default(false) @map("is_living")
  isBlok              Boolean              @default(false) @map("is_blok")
  isVlak              Boolean              @default(false) @map("is_vlak")
  isCt70              Boolean              @default(false) @map("is_ct70")
  isFocusing          Boolean              @default(false) @map("is_focusing")
  // Planowanie produkcji - dodane 2026-01-15
  profileType         String               @default("typical") @map("profile_type") // 'typical' | 'atypical' - wp≈Çywa na lead time
  isPalletized        Boolean              @default(false) @map("is_palletized") // Czy profil jest w paletach (przygotowanie sobota)
  efficiencyCoeff     Decimal?             @map("efficiency_coeff") // Wsp√≥≈Çczynnik wydajno≈õci (np. 0.9 = wolniejszy o 10%)
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  orderRequirements   OrderRequirement[]
  profileColors       ProfileColor[]
  warehouseHistory    WarehouseHistory[]
  warehouseOrders     WarehouseOrder[]
  warehouseStock      WarehouseStock[]
  profilePalletConfig ProfilePalletConfig?

  @@map("profiles")
}

model Color {
  id                Int                @id @default(autoincrement())
  code              String             @unique
  name              String
  type              String
  hexColor          String?            @map("hex_color")
  isAkrobud         Boolean            @default(false) @map("is_akrobud") // Czy pokazywaƒá w magazynie Akrobud
  // Planowanie produkcji - dodane 2026-01-15
  isTypical         Boolean            @default(true) @map("is_typical") // Czy kolor typowy (grupowany w produkcji)
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  orderRequirements OrderRequirement[]
  profileColors     ProfileColor[]
  warehouseHistory  WarehouseHistory[]
  warehouseOrders   WarehouseOrder[]
  warehouseStock    WarehouseStock[]

  @@map("colors")
}

// Kolory prywatne (zewnƒôtrzne) - automatycznie tworzone podczas importu uzyte_bele_prywatne
// Nie sƒÖ czƒô≈õciƒÖ standardowej palety Akrobud, ale muszƒÖ byƒá ≈õledzone dla raport√≥w
model PrivateColor {
  id                Int                @id @default(autoincrement())
  code              String             @unique // Numer koloru z importu (np. "354", "170")
  name              String? // Opcjonalna nazwa do uzupe≈Çnienia przez u≈ºytkownika
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  // Relacje
  orderRequirements OrderRequirement[] @relation("PrivateColorRequirements")

  @@map("private_colors")
}

model ProfileColor {
  id        Int     @id @default(autoincrement())
  profileId Int     @map("profile_id")
  colorId   Int     @map("color_id")
  isVisible Boolean @default(true) @map("is_visible")
  color     Color   @relation(fields: [colorId], references: [id], onDelete: Cascade)
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, colorId])
  // Dodane 2026-01-15 - audyt wydajno≈õci: indeksy FK
  @@index([profileId])
  @@index([colorId])
  @@map("profile_colors")
}

model Order {
  id                      Int                       @id @default(autoincrement())
  orderNumber             String                    @unique @map("order_number")
  status                  String                    @default("new")
  client                  String?
  project                 String?
  system                  String?
  deadline                DateTime?
  pvcDeliveryDate         DateTime?                 @map("pvc_delivery_date")
  valuePln                Int?                      @map("value_pln")
  valueEur                Int?                      @map("value_eur")
  // Numer zam√≥wienia bazowego z kt√≥rego odziedziczono cenƒô (np. "53477" dla "53477-a")
  priceInheritedFromOrder String?                   @map("price_inherited_from_order")
  invoiceNumber           String?                   @map("invoice_number")
  deliveryDate            DateTime?                 @map("delivery_date")
  productionDate          DateTime?                 @map("production_date")
  glassDeliveryDate       DateTime?                 @map("glass_delivery_date")
  notes                   String?
  createdAt               DateTime                  @default(now()) @map("created_at")
  updatedAt               DateTime                  @updatedAt @map("updated_at")
  archivedAt              DateTime?                 @map("archived_at")
  totalGlasses            Int?                      @map("total_glasses")
  totalSashes             Int?                      @map("total_sashes")
  totalWindows            Int?                      @map("total_windows")
  completedAt             DateTime?                 @map("completed_at")
  orderedGlassCount       Int?                      @default(0) @map("ordered_glass_count")
  deliveredGlassCount     Int?                      @default(0) @map("delivered_glass_count")
  glassOrderStatus        String?                   @default("not_ordered") @map("glass_order_status")
  // Notatka z zam√≥wienia szyb (np. "Zam. - szprosy")
  glassOrderNote          String?                   @map("glass_order_note")
  // Status okuƒá dla zlecenia: 'none' | 'no_okuc' | 'imported' | 'has_atypical' | 'pending'
  // none - brak zapotrzebowania, no_okuc - zlecenie bez okuƒá (pusty plik), imported - zaimportowano, has_atypical - sƒÖ nietypowe, pending - czeka na zlecenie
  okucDemandStatus        String?                   @default("none") @map("okuc_demand_status")
  // P1-2: Typ wariantu zlecenia
  // 'correction' - korekta orygina≈Çu (musi byƒá w tej samej dostawie co orygina≈Ç)
  // 'additional_file' - dodatkowy plik do zam√≥wienia (mo≈ºe byƒá w innej dostawie)
  // null - nie okre≈õlono (domy≈õlnie, wymagane dla wariant√≥w z literkƒÖ)
  variantType             String?                   @map("variant_type")
  // Autor dokumentu z CSV (np. "Wlodek", "Arek", "Krzysztof")
  documentAuthor          String?                   @map("document_author")
  // Przypisany u≈ºytkownik systemu (je≈õli znaleziono mapowanie)
  documentAuthorUserId    Int?                      @map("document_author_user_id")
  documentAuthorUser      User?                     @relation("OrderDocumentAuthor", fields: [documentAuthorUserId], references: [id], onDelete: SetNull)
  // Sumy z materia≈Ç√≥wki - warto≈õci w groszach
  windowsNetValue         Int?                      @map("windows_net_value") // Suma netto okien (kategoria 'okno')
  windowsMaterial         Int?                      @map("windows_material") // Suma materia≈Çu okien (kategoria 'okno')
  assemblyValue           Int?                      @map("assembly_value") // Suma monta≈ºu (kategoria 'montaz')
  extrasValue             Int?                      @map("extras_value") // Suma dodatk√≥w (kategoria 'dodatki')
  otherValue              Int?                      @map("other_value") // Suma inne (kategoria 'inne')
  // Rƒôczny status ustawiony przez u≈ºytkownika
  // 'do_not_cut' - NIE CIƒÑƒÜ (≈º√≥≈Çte t≈Ço, okucia nie w zapotrzebowaniu)
  // 'cancelled' - Anulowane (czerwone t≈Ço, archiwizacja po 30 dniach, cofnij profile/okucia z zapotrzebowania)
  // 'on_hold' - Wstrzymane (pomara≈Ñczowe t≈Ço)
  // null - brak rƒôcznego statusu
  manualStatus            String?                   @map("manual_status")
  manualStatusSetAt       DateTime?                 @map("manual_status_set_at")
  // Typ specjalny zlecenia (nietyp√≥wka): 'drzwi', 'psk', 'hs', 'ksztalt'
  // null - brak typu specjalnego (standardowe zlecenie)
  specialType             String?                   @map("special_type")
  // Soft delete - data usuniƒôcia zlecenia
  deletedAt               DateTime?                 @map("deleted_at")
  deletedByUserId         Int?                      @map("deleted_by_user_id")
  deletedByUser           User?                     @relation("OrderDeletedBy", fields: [deletedByUserId], references: [id], onDelete: SetNull)
  deliveryOrders          DeliveryOrder[]
  // Removed glassOrderItems relation - no FK constraint (glass orders can exist without production order)
  monthlyReportItems      MonthlyReportItem[]
  orderNotes              Note[]
  requirements            OrderRequirement[]
  windows                 OrderWindow[]
  glasses                 OrderGlass[]
  materials               OrderMaterial[]
  schucoLinks             OrderSchucoLink[]
  okucDemands             OkucDemand[]
  verificationItems       AkrobudVerificationItem[]
  verificationItemOrders  VerificationItemOrder[] // Zlecenia powiƒÖzane z projektami weryfikacji
  productionReportItems   ProductionReportItem[]    @relation("ProductionReportItems")
  conflictsAsBase         PendingImportConflict[]   @relation("ConflictBaseOrder")
  steelRequirements       OrderSteelRequirement[]
  logisticsMailItems      LogisticsMailItem[]

  @@index([status])
  @@index([archivedAt])
  @@index([createdAt])
  @@index([invoiceNumber, createdAt])
  @@index([invoiceNumber, deliveryDate])
  @@index([status, archivedAt])
  @@index([glassOrderStatus])
  @@index([glassOrderStatus, archivedAt])
  @@index([deliveryDate, status])
  @@index([okucDemandStatus])
  // Dodane 2026-01-15 - audyt bazy danych
  @@index([productionDate])
  @@index([completedAt])
  @@index([documentAuthorUserId, archivedAt])
  @@index([manualStatus])
  @@index([deletedAt])
  @@map("orders")
}

model OrderRequirement {
  id             Int           @id @default(autoincrement())
  orderId        Int           @map("order_id")
  profileId      Int           @map("profile_id")
  colorId        Int?          @map("color_id") // Kolor Akrobud (null je≈õli u≈ºyto privateColor)
  privateColorId Int?          @map("private_color_id") // Kolor prywatny (dla import√≥w prywatnych)
  beamsCount     Int           @map("beams_count")
  meters         Float
  restMm         Int           @map("rest_mm")
  status         String        @default("pending") // pending | completed (dla RW)
  createdAt      DateTime      @default(now()) @map("created_at")
  color          Color?        @relation(fields: [colorId], references: [id], onDelete: Restrict)
  privateColor   PrivateColor? @relation("PrivateColorRequirements", fields: [privateColorId], references: [id], onDelete: Restrict)
  profile        Profile       @relation(fields: [profileId], references: [id], onDelete: Restrict)
  order          Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, profileId, colorId])
  @@unique([orderId, profileId, privateColorId])
  @@index([colorId])
  @@index([privateColorId])
  @@index([profileId])
  @@index([createdAt])
  @@index([status])
  @@map("order_requirements")
}

model OrderWindow {
  id          Int             @id @default(autoincrement())
  orderId     Int             @map("order_id")
  position    Int             @default(0) // Numer pozycji (Lp. z listy okien)
  widthMm     Int             @map("width_mm")
  heightMm    Int             @map("height_mm")
  profileType String          @map("profile_type")
  quantity    Int
  reference   String?
  createdAt   DateTime        @default(now()) @map("created_at")
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  materials   OrderMaterial[] // Materia≈Ç√≥wka przypisana do tego okna

  @@index([profileType])
  @@index([orderId, position])
  @@map("order_windows")
}

// Szyby przypisane do zlecenia (wstƒôpna lista z pliku uzyte_bele)
model OrderGlass {
  id          Int      @id @default(autoincrement())
  orderId     Int      @map("order_id")
  lp          Int // Lp. z pliku CSV
  position    Int // Pozycja (odpowiada Lp. z listy okien)
  widthMm     Int      @map("width_mm") // Szeroko≈õƒá w mm
  heightMm    Int      @map("height_mm") // Wysoko≈õƒá w mm
  quantity    Int // Ilo≈õƒá sztuk
  packageType String   @map("package_type") // Typ pakietu np. "4/18/4/18/4S3 Ug=0.5"
  areaSqm     Float    @map("area_sqm") // Obliczona powierzchnia w m¬≤
  createdAt   DateTime @default(now()) @map("created_at")
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([position])
  @@map("order_glasses")
}

// Materia≈Ç√≥wka - pozycje kosztowe z pliku uzyte_bele
// Kategorie: 'okno' (przypisana do okna), 'montaz' (tylko warto≈õƒá monta≈ºu),
//            'dodatki' (pozycja > liczba okien), 'inne' (material=0 ale warto≈õƒá netto > 0)
model OrderMaterial {
  id                          Int          @id @default(autoincrement())
  orderId                     Int          @map("order_id")
  orderWindowId               Int?         @map("order_window_id") // PowiƒÖzanie z oknem (tylko dla kategorii 'okno')
  position                    Int // Numer pozycji z pliku
  category                    String // 'okno' | 'montaz' | 'dodatki' | 'inne'
  glazing                     Int          @default(0) @map("glazing") // Szklenia w groszach
  fittings                    Int          @default(0) @map("fittings") // Okucia w groszach
  parts                       Int          @default(0) @map("parts") // Czƒô≈õci w groszach
  glassQuantity               Int          @default(0) @map("glass_quantity") // Ilo≈õƒá szk≈Ça
  material                    Int          @default(0) @map("material") // Materia≈Ç w groszach
  assemblyValueBeforeDiscount Int          @default(0) @map("assembly_value_before_discount") // Warto≈õƒá netto monta≈ºu przed rabatem w groszach
  assemblyValueAfterDiscount  Int          @default(0) @map("assembly_value_after_discount") // Warto≈õƒá netto monta≈ºu po rabacie w groszach
  netValue                    Int          @default(0) @map("net_value") // Warto≈õƒá netto w groszach
  totalNet                    Int          @default(0) @map("total_net") // Suma netto w groszach
  quantity                    Int          @default(1) // Sztuk
  coefficient                 Float?       @map("coefficient") // Wsp√≥≈Çczynnik
  unit                        Float? // Jednostka
  createdAt                   DateTime     @default(now()) @map("created_at")
  order                       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderWindow                 OrderWindow? @relation(fields: [orderWindowId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([category])
  @@index([orderWindowId])
  @@map("order_materials")
}

model WarehouseStock {
  id                Int       @id @default(autoincrement())
  profileId         Int       @map("profile_id")
  colorId           Int       @map("color_id")
  currentStockBeams Int       @default(0) @map("current_stock_beams")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  updatedById       Int?      @map("updated_by_id")
  initialStockBeams Int       @default(0) @map("initial_stock_beams")
  remanentDate      DateTime? @map("remanent_date") // Data ostatniego remanentu - ustawiana rƒôcznie, NIE automatycznie
  version           Int       @default(0)
  deletedAt         DateTime? @map("deleted_at")
  updatedBy         User?     @relation("UpdatedBy", fields: [updatedById], references: [id])
  color             Color     @relation(fields: [colorId], references: [id], onDelete: Restrict)
  profile           Profile   @relation(fields: [profileId], references: [id], onDelete: Restrict)

  @@unique([profileId, colorId])
  @@index([deletedAt])
  @@index([colorId]) // Dodane 2026-01-16 - czeste filtrowanie po kolorze
  // Dodane 2026-01-15 - audyt wydajno≈õci: indeks FK
  @@index([updatedById])
  @@map("warehouse_stock")
}

model WarehouseOrder {
  id                   Int      @id @default(autoincrement())
  profileId            Int      @map("profile_id")
  colorId              Int      @map("color_id")
  orderedBeams         Int      @map("ordered_beams")
  expectedDeliveryDate DateTime @map("expected_delivery_date")
  status               String   @default("pending")
  notes                String?
  createdAt            DateTime @default(now()) @map("created_at")
  createdById          Int?     @map("created_by_id")
  createdBy            User?    @relation("WarehouseOrderCreatedBy", fields: [createdById], references: [id])
  color                Color    @relation(fields: [colorId], references: [id], onDelete: Restrict)
  profile              Profile  @relation(fields: [profileId], references: [id], onDelete: Restrict)

  @@unique([profileId, colorId, expectedDeliveryDate])
  @@index([status])
  @@index([expectedDeliveryDate])
  @@index([colorId, status]) // Dodane 2026-01-16 - filtrowanie zamowien po kolorze i statusie
  @@map("warehouse_orders")
}

model WarehouseHistory {
  id              Int      @id @default(autoincrement())
  profileId       Int      @map("profile_id")
  colorId         Int      @map("color_id")
  calculatedStock Int      @map("calculated_stock")
  actualStock     Int      @map("actual_stock")
  difference      Int
  previousStock   Int?     @map("previous_stock")
  currentStock    Int?     @map("current_stock")
  changeType      String?  @map("change_type")
  notes           String?
  recordedAt      DateTime @default(now()) @map("recorded_at")
  recordedById    Int?     @map("recorded_by_id")
  recordedBy      User?    @relation("RecordedBy", fields: [recordedById], references: [id])
  color           Color    @relation(fields: [colorId], references: [id], onDelete: Restrict)
  profile         Profile  @relation(fields: [profileId], references: [id], onDelete: Restrict)

  @@index([colorId])
  @@index([profileId])
  @@index([recordedAt])
  @@index([changeType])
  @@map("warehouse_history")
}

model Delivery {
  id                Int                       @id @default(autoincrement())
  deliveryDate      DateTime                  @map("delivery_date")
  deliveryNumber    String?                   @map("delivery_number")
  status            String                    @default("planned")
  notes             String?
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  deletedAt         DateTime?                 @map("deleted_at")
  deliveryItems     DeliveryItem[]
  deliveryOrders    DeliveryOrder[]
  optimization      PalletOptimization?
  verificationLists AkrobudVerificationList[]
  labelChecks       LabelCheck[]

  // Agregowany status gotowo≈õci dostawy
  readiness          DeliveryReadiness?
  // PowiƒÖzane listy mailowe (logistyka)
  logisticsMailLists LogisticsMailList[]

  @@index([status])
  @@index([deliveryDate])
  @@index([createdAt])
  @@index([deliveryDate, status])
  @@index([status, deliveryDate])
  @@index([deletedAt])
  @@index([status, deletedAt])
  @@map("deliveries")
}

// Agregowany status gotowo≈õci dostawy
// Przechowuje wyliczony status z wszystkich modu≈Ç√≥w sprawdzajƒÖcych
// Status: ready (üü¢) | conditional (üü†) | blocked (üî¥) | pending
model DeliveryReadiness {
  id         Int @id @default(autoincrement())
  deliveryId Int @unique @map("delivery_id")

  // Agregowany status: ready | conditional | blocked | pending
  aggregatedStatus String @default("pending") @map("aggregated_status")

  // Timestamp ostatniego przeliczenia
  lastCalculatedAt DateTime @default(now()) @map("last_calculated_at")

  // Liczniki dla szybkiego dostƒôpu w UI
  blockingCount Int @default(0) @map("blocking_count")
  warningCount  Int @default(0) @map("warning_count")

  // Szczeg√≥≈Çowe wyniki z ka≈ºdego modu≈Çu (JSON)
  // Format: [{ module: string, status: 'ok'|'warning'|'blocking', message: string }]
  moduleResults String? @map("module_results")

  // Powody blokady (JSON array of strings) - skr√≥t dla UI
  blockingReasons String? @map("blocking_reasons")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@index([aggregatedStatus])
  @@index([lastCalculatedAt])
  @@map("delivery_readiness")
}

model DeliveryOrder {
  id         Int      @id @default(autoincrement())
  deliveryId Int      @map("delivery_id")
  orderId    Int      @map("order_id")
  position   Int
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  delivery   Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@unique([deliveryId, orderId])
  @@index([deliveryId, position])
  // Dodane 2026-01-15 - audyt: reverse lookup (order ‚Üí deliveries)
  @@index([orderId])
  @@map("delivery_orders")
}

model DeliveryItem {
  id          Int      @id @default(autoincrement())
  deliveryId  Int      @map("delivery_id")
  itemType    String   @map("item_type")
  description String
  quantity    Int
  createdAt   DateTime @default(now()) @map("created_at")
  delivery    Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@index([deliveryId]) // Dodano 2026-01-23 - brakujƒÖcy indeks FK dla optymalizacji JOIN√≥w
  @@map("delivery_items")
}

model PalletType {
  id          Int      @id @default(autoincrement())
  name        String
  lengthMm    Int      @map("length_mm")
  widthMm     Int      @map("width_mm")
  heightMm    Int      @map("height_mm")
  loadWidthMm Int      @default(0) @map("load_width_mm")
  loadDepthMm Int      @default(6000) @map("load_depth_mm")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("pallet_types")
}

model ProfileDepth {
  id          Int      @id @default(autoincrement())
  profileType String   @unique @map("profile_type")
  depthMm     Int      @map("depth_mm")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("profile_depths")
}

// Przelicznik: ile beli profilu mie≈õci siƒô w jednej palecie Schuco
model ProfilePalletConfig {
  id             Int      @id @default(autoincrement())
  profileId      Int      @unique @map("profile_id")
  beamsPerPallet Int      @map("beams_per_pallet")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  profile Profile @relation(fields: [profileId], references: [id])

  @@map("profile_pallet_configs")
}

model PackingRule {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  ruleConfig  String   @map("rule_config")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("packing_rules")
}

model PalletOptimization {
  id               Int               @id @default(autoincrement())
  deliveryId       Int               @unique @map("delivery_id")
  totalPallets     Int               @map("total_pallets")
  optimizationData String            @map("optimization_data")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  // P0-R2: Physical validation status
  // 'pending' - awaiting validation, 'valid' - validated OK, 'invalid' - validation failed
  validationStatus String?           @default("pending") @map("validation_status")
  validatedAt      DateTime?         @map("validated_at")
  validationErrors String?           @map("validation_errors")
  pallets          OptimizedPallet[]
  delivery         Delivery          @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@map("pallet_optimizations")
}

model OptimizedPallet {
  id                 Int                @id @default(autoincrement())
  optimizationId     Int                @map("optimization_id")
  palletNumber       Int                @map("pallet_number")
  palletTypeName     String             @map("pallet_type_name")
  palletWidth        Int                @map("pallet_width")
  usedDepthMm        Int                @map("used_depth_mm")
  maxDepthMm         Int                @map("max_depth_mm")
  utilizationPercent Float              @map("utilization_percent")
  windowsData        String             @map("windows_data")
  optimization       PalletOptimization @relation(fields: [optimizationId], references: [id], onDelete: Cascade)

  @@index([optimizationId])
  @@map("optimized_pallets")
}

model FileImport {
  id                 Int                 @id @default(autoincrement())
  filename           String
  filepath           String
  fileType           String              @map("file_type")
  status             String              @default("pending")
  processedAt        DateTime?           @map("processed_at")
  errorMessage       String?             @map("error_message")
  metadata           String?
  deletedAt          DateTime?           @map("deleted_at") // Soft delete
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  glassDeliveries    GlassDelivery[]
  pendingOrderPrices PendingOrderPrice[]

  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([deletedAt])
  @@map("file_imports")
}

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model Note {
  id          Int      @id @default(autoincrement())
  orderId     Int?     @map("order_id")
  content     String
  createdAt   DateTime @default(now()) @map("created_at")
  createdById Int?     @map("created_by_id")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   User?    @relation(fields: [createdById], references: [id])
  order       Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Dodane 2026-01-15 - audyt wydajno≈õci: indeksy FK
  @@index([orderId])
  @@index([createdById])
  @@map("notes")
}

model WorkingDay {
  id          Int      @id @default(autoincrement())
  date        DateTime @unique
  isWorking   Boolean  @default(true) @map("is_working")
  description String?
  isHoliday   Boolean  @default(false) @map("is_holiday")
  country     String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Dodane 2026-01-15 - audyt: liczenie dni roboczych w zakresie dat
  @@index([isWorking, date])
  @@map("working_days")
}

model SchucoDelivery {
  id                 Int               @id @default(autoincrement())
  orderDate          String            @map("order_date")
  orderNumber        String            @unique @map("order_number")
  projectNumber      String            @map("project_number")
  orderName          String            @map("order_name")
  shippingStatus     String            @map("shipping_status")
  deliveryWeek       String?           @map("delivery_week")
  deliveryDate       DateTime?         @map("delivery_date") // Sparsowana data dostawy (poniedzia≈Çek tygodnia)
  deliveryType       String?           @map("delivery_type")
  tracking           String?
  complaint          String?
  orderType          String?           @map("order_type")
  totalAmount        String?           @map("total_amount")
  rawData            String?           @map("raw_data")
  fetchedAt          DateTime          @default(now()) @map("fetched_at")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  orderDateParsed    DateTime?         @map("order_date_parsed")
  changeType         String?           @map("change_type")
  changedAt          DateTime?         @map("changed_at")
  changedFields      String?           @map("changed_fields")
  previousValues     String?           @map("previous_values")
  isWarehouseItem    Boolean           @default(false) @map("is_warehouse_item")
  extractedOrderNums String?           @map("extracted_order_nums")
  archivedAt         DateTime?         @map("archived_at") // Data archiwizacji - zrealizowane zam√≥wienia > 3 miesiƒÖce
  itemsFetchedAt     DateTime?         @map("items_fetched_at") // Kiedy ostatnio pobrano pozycje zam√≥wienia
  orderLinks         OrderSchucoLink[]
  items              SchucoOrderItem[]

  @@index([fetchedAt])
  @@index([itemsFetchedAt])
  @@index([archivedAt])
  @@index([orderNumber])
  @@index([orderDate])
  @@index([orderDateParsed])
  @@index([changeType])
  @@index([changedAt])
  @@index([changeType, changedAt])
  @@index([orderDateParsed, shippingStatus])
  @@index([shippingStatus, orderDateParsed])
  @@index([isWarehouseItem])
  @@index([orderNumber, fetchedAt])
  @@index([deliveryDate])
  @@map("schuco_deliveries")
}

model SchucoFetchLog {
  id               Int       @id @default(autoincrement())
  status           String
  triggerType      String    @default("manual") @map("trigger_type")
  recordsCount     Int?      @map("records_count")
  newRecords       Int?      @map("new_records")
  updatedRecords   Int?      @map("updated_records")
  unchangedRecords Int?      @map("unchanged_records")
  errorMessage     String?   @map("error_message")
  startedAt        DateTime  @default(now()) @map("started_at")
  completedAt      DateTime? @map("completed_at")
  durationMs       Int?      @map("duration_ms")

  @@index([startedAt])
  @@index([triggerType])
  @@map("schuco_fetch_logs")
}

// Gmail IMAP - log pobierania za≈ÇƒÖcznik√≥w CSV z maili
model GmailFetchLog {
  id             Int       @id @default(autoincrement())
  messageUid     String    @map("message_uid")
  subject        String?
  sender         String?
  receivedAt     DateTime? @map("received_at")
  attachmentName String?   @map("attachment_name")
  savedFilePath  String?   @map("saved_file_path")
  status         String    @default("pending") // pending | downloaded | failed
  errorMessage   String?   @map("error_message")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@unique([messageUid])
  @@index([status])
  @@index([createdAt])
  @@map("gmail_fetch_logs")
}

// Pozycje zam√≥wienia Sch√ºco - artyku≈Çy w zam√≥wieniu
model SchucoOrderItem {
  id                 Int       @id @default(autoincrement())
  schucoDeliveryId   Int       @map("schuco_delivery_id")
  position           Int // Pozycja w zam√≥wieniu (1, 2, 3...)
  articleNumber      String    @map("article_number") // Nr artyku≈Çu (np. 19411460)
  articleDescription String    @map("article_description") // Opis artyku≈Çu
  orderedQty         Int       @map("ordered_qty") // Zam√≥wiona ilo≈õƒá
  shippedQty         Int       @map("shipped_qty") // Wys≈Çana ilo≈õƒá
  unit               String    @default("szt.") // Jednostka
  dimensions         String? // Wymiary (np. 6000 mm)
  configuration      String? // Konfiguracja
  deliveryWeek       String?   @map("delivery_week") // Tydzie≈Ñ dostawy (np. 2026/7)
  deliveryDate       DateTime? @map("delivery_date") // Sparsowana data dostawy (poniedzia≈Çek tygodnia)
  tracking           String? // ≈öledzenie
  comment            String? // Komentarz

  // Change tracking
  changeType     String?   @map("change_type") // "new" | "updated" | null
  changedAt      DateTime? @map("changed_at")
  changedFields  String?   @map("changed_fields") // JSON array p√≥l kt√≥re siƒô zmieni≈Çy
  previousValues String?   @map("previous_values") // JSON poprzednie warto≈õci

  // Timestamps
  fetchedAt DateTime @default(now()) @map("fetched_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  schucoDelivery SchucoDelivery @relation(fields: [schucoDeliveryId], references: [id], onDelete: Cascade)

  @@unique([schucoDeliveryId, position])
  @@index([schucoDeliveryId])
  @@index([articleNumber])
  @@index([changeType, changedAt])
  @@index([deliveryDate])
  @@map("schuco_order_items")
}

model MonthlyReport {
  id            Int                 @id @default(autoincrement())
  year          Int
  month         Int
  reportDate    DateTime            @default(now()) @map("report_date")
  totalOrders   Int                 @default(0) @map("total_orders")
  totalWindows  Int                 @default(0) @map("total_windows")
  totalSashes   Int                 @default(0) @map("total_sashes")
  totalValuePln Int                 @default(0) @map("total_value_pln")
  totalValueEur Int                 @default(0) @map("total_value_eur")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")
  reportItems   MonthlyReportItem[]

  @@unique([year, month])
  // Usuniƒôto @@index([year, month]) - duplikat (@@unique automatycznie tworzy indeks)
  @@index([reportDate])
  @@map("monthly_reports")
}

model MonthlyReportItem {
  id            Int           @id @default(autoincrement())
  reportId      Int           @map("report_id")
  orderId       Int           @map("order_id")
  orderNumber   String        @map("order_number")
  invoiceNumber String?       @map("invoice_number")
  windowsCount  Int           @default(0) @map("windows_count")
  sashesCount   Int           @default(0) @map("sashes_count")
  unitsCount    Int           @default(0) @map("units_count")
  valuePln      Int?          @map("value_pln")
  valueEur      Int?          @map("value_eur")
  createdAt     DateTime      @default(now()) @map("created_at")
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Restrict)
  report        MonthlyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([orderId])
  @@map("monthly_report_items")
}

model CurrencyConfig {
  id            Int      @id @default(autoincrement())
  eurToPlnRate  Int      @map("eur_to_pln_rate")
  effectiveDate DateTime @default(now()) @map("effective_date")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([effectiveDate])
  @@map("currency_config")
}

model GlassDelivery {
  id                  Int                 @id @default(autoincrement())
  rackNumber          String              @map("rack_number")
  customerOrderNumber String              @map("customer_order_number")
  supplierOrderNumber String?             @map("supplier_order_number")
  deliveryDate        DateTime            @map("delivery_date")
  fileImportId        Int?                @map("file_import_id")
  createdAt           DateTime            @default(now()) @map("created_at")
  fileImport          FileImport?         @relation(fields: [fileImportId], references: [id])
  items               GlassDeliveryItem[]
  looseGlasses        LooseGlass[]
  aluminumGlasses     AluminumGlass[]
  reclamationGlasses  ReclamationGlass[]

  @@index([deliveryDate])
  @@index([customerOrderNumber])
  @@index([rackNumber])
  @@index([fileImportId]) // Dodano 2026-01-23 - brakujƒÖcy indeks FK dla optymalizacji JOIN√≥w
  @@map("glass_deliveries")
}

model GlassDeliveryItem {
  id                  Int           @id @default(autoincrement())
  glassDeliveryId     Int           @map("glass_delivery_id")
  glassOrderId        Int?          @map("glass_order_id")
  orderNumber         String        @map("order_number")
  orderSuffix         String?       @map("order_suffix")
  position            String
  widthMm             Int           @map("width_mm")
  heightMm            Int           @map("height_mm")
  quantity            Int
  glassComposition    String?       @map("glass_composition")
  serialNumber        String?       @map("serial_number")
  clientCode          String?       @map("client_code")
  matchStatus         String        @default("pending") @map("match_status")
  matchedItemId       Int?          @map("matched_item_id")
  // Numer zam√≥wienia klienta (z wiersza CSV) - mo≈ºe r√≥≈ºniƒá siƒô od parent GlassDelivery
  customerOrderNumber String?       @map("customer_order_number")
  // Numer stojaka (z wiersza CSV) - mo≈ºe r√≥≈ºniƒá siƒô od parent GlassDelivery
  rackNumber          String?       @map("rack_number")
  createdAt           DateTime      @default(now()) @map("created_at")
  glassOrder          GlassOrder?   @relation(fields: [glassOrderId], references: [id], onDelete: SetNull)
  glassDelivery       GlassDelivery @relation(fields: [glassDeliveryId], references: [id], onDelete: Cascade)

  @@index([glassDeliveryId, orderNumber, position])
  @@index([widthMm, heightMm])
  @@index([matchStatus])
  @@index([orderNumber, orderSuffix])
  @@index([orderNumber])
  @@index([glassDeliveryId])
  @@index([customerOrderNumber])
  @@map("glass_delivery_items")
}

model GlassOrderItem {
  id           Int        @id @default(autoincrement())
  glassOrderId Int        @map("glass_order_id")
  orderNumber  String     @map("order_number")
  orderSuffix  String?    @map("order_suffix")
  position     String
  glassType    String     @map("glass_type")
  widthMm      Int        @map("width_mm")
  heightMm     Int        @map("height_mm")
  quantity     Int
  createdAt    DateTime   @default(now()) @map("created_at")
  // Removed FK constraint - allow glass orders even when production order doesn't exist yet
  // Validation warnings are created via GlassOrderValidation table
  glassOrder   GlassOrder @relation(fields: [glassOrderId], references: [id], onDelete: Cascade)

  // Usuniƒôto @@unique([glassOrderId, position]) - wiele szyb mo≈ºe byƒá na tej samej pozycji
  // (np. pakiet szybowy z dwoma skrzyd≈Çami HST ma 2+ szyby na poz.1)
  @@index([glassOrderId, orderNumber, position])
  @@index([widthMm, heightMm])
  @@index([orderNumber, orderSuffix])
  @@index([orderNumber])
  @@index([glassOrderId])
  @@map("glass_order_items")
}

model GlassOrderValidation {
  id                Int         @id @default(autoincrement())
  glassOrderId      Int?        @map("glass_order_id")
  orderNumber       String      @map("order_number")
  validationType    String      @map("validation_type")
  severity          String
  expectedQuantity  Int?        @map("expected_quantity")
  orderedQuantity   Int?        @map("ordered_quantity")
  deliveredQuantity Int?        @map("delivered_quantity")
  message           String
  details           String?
  resolved          Boolean     @default(false)
  resolvedAt        DateTime?   @map("resolved_at")
  resolvedBy        String?     @map("resolved_by")
  createdAt         DateTime    @default(now()) @map("created_at")
  glassOrder        GlassOrder? @relation(fields: [glassOrderId], references: [id], onDelete: Cascade)

  @@index([resolved])
  @@index([severity])
  @@index([orderNumber])
  @@index([glassOrderId])
  @@map("glass_order_validations")
}

model GlassOrder {
  id                   Int                    @id @default(autoincrement())
  glassOrderNumber     String                 @unique @map("glass_order_number")
  orderDate            DateTime               @map("order_date")
  supplier             String
  orderedBy            String?                @map("ordered_by")
  expectedDeliveryDate DateTime?              @map("expected_delivery_date")
  actualDeliveryDate   DateTime?              @map("actual_delivery_date")
  status               String                 @default("ordered")
  notes                String?
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  deletedAt            DateTime?              @map("deleted_at")
  deliveryItems        GlassDeliveryItem[]
  items                GlassOrderItem[]
  validationResults    GlassOrderValidation[]

  @@index([expectedDeliveryDate])
  @@index([status])
  @@index([orderDate])
  // Usuniƒôto @@index([glassOrderNumber]) - duplikat (@unique automatycznie tworzy indeks)
  @@index([deletedAt])
  @@map("glass_orders")
}

model OrderSchucoLink {
  id               Int            @id @default(autoincrement())
  orderId          Int            @map("order_id")
  schucoDeliveryId Int            @map("schuco_delivery_id")
  linkedAt         DateTime       @default(now()) @map("linked_at")
  linkedBy         String?        @map("linked_by")
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  schucoDelivery   SchucoDelivery @relation(fields: [schucoDeliveryId], references: [id], onDelete: Cascade)

  @@unique([orderId, schucoDeliveryId])
  @@index([orderId])
  @@index([schucoDeliveryId])
  @@map("order_schuco_links")
}

model UserFolderSettings {
  id              Int      @id @default(autoincrement())
  userId          Int?     @unique @map("user_id")
  importsBasePath String   @map("imports_base_path")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("user_folder_settings")
}

model ImportLock {
  id         Int      @id @default(autoincrement())
  folderPath String   @unique @map("folder_path")
  userId     Int      @map("user_id")
  lockedAt   DateTime @default(now()) @map("locked_at")
  expiresAt  DateTime @map("expires_at")
  processId  String?  @map("process_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
  @@map("import_locks")
}

// Ceny profili oczekujƒÖce na powiƒÖzanie ze zleceniem
// Gdy importujemy PDF z cenƒÖ ale zlecenie jeszcze nie istnieje,
// zapisujemy tu cenƒô i automatycznie przypisujemy gdy zlecenie siƒô pojawi
model PendingOrderPrice {
  id               Int       @id @default(autoincrement())
  orderNumber      String    @map("order_number")
  reference        String?
  currency         String // EUR lub PLN
  valueNetto       Int       @map("value_netto")
  valueBrutto      Int?      @map("value_brutto")
  filename         String // oryginalny nazwa pliku PDF
  filepath         String // ≈õcie≈ºka do pliku
  importId         Int?      @map("import_id")
  status           String    @default("pending") // pending, applied, expired
  appliedAt        DateTime? @map("applied_at")
  appliedToOrderId Int?      @map("applied_to_order_id")
  expiresAt        DateTime? @map("expires_at") // optional TTL - when this record should be cleaned up
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  fileImport FileImport? @relation(fields: [importId], references: [id], onDelete: SetNull)

  @@index([orderNumber])
  @@index([status])
  @@index([orderNumber, status])
  @@index([expiresAt])
  @@index([status, expiresAt])
  @@index([status, appliedAt])
  @@map("pending_order_prices")
}

// =============================================================================
// DUALSTOCK MODULE - Magazyn okuƒá (PVC + ALU)
// =============================================================================

// Lokalizacje magazynowe dla okuƒá (edytowalne w ustawieniach)
model OkucLocation {
  id        Int       @id @default(autoincrement())
  name      String    @unique // "Schuco", "Namiot", "Hala skrzyd≈Ça", etc.
  sortOrder Int       @default(0) @map("sort_order")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at") // Soft delete

  articles OkucArticle[]

  @@index([deletedAt])
  @@index([sortOrder])
  @@map("okuc_locations")
}

// Artyku≈Ç okuciowy - podstawowa jednostka w systemie
model OkucArticle {
  id          Int     @id @default(autoincrement())
  articleId   String  @unique @map("article_id") // Numer artyku≈Çu (np. "A123")
  name        String
  description String?

  // Klasyfikacja
  usedInPvc  Boolean @default(false) @map("used_in_pvc")
  usedInAlu  Boolean @default(false) @map("used_in_alu")
  orderClass String  @default("typical") @map("order_class") // 'typical' | 'atypical'
  sizeClass  String  @default("standard") @map("size_class") // 'standard' | 'gabarat'

  // Jednostki i opakowania
  orderUnit      String  @default("piece") @map("order_unit") // 'piece' | 'pack'
  packagingSizes String? @map("packaging_sizes") // JSON: [50, 100]
  preferredSize  Int?    @map("preferred_size")

  // Dane dostawcy
  supplierCode String? @map("supplier_code")
  leadTimeDays Int     @default(14) @map("lead_time_days")
  safetyDays   Int     @default(3) @map("safety_days")
  priceEur     Int?    @map("price_eur") // Cena w eurocentach (np. 200 = 2,00 EUR)

  // Lokalizacja magazynowa
  locationId Int? @map("location_id")

  // Zastƒôpstwa artyku≈Ç√≥w (wygaszanie)
  isPhaseOut          Boolean   @default(false) @map("is_phase_out") // Artyku≈Ç wygaszany - nie zamawiaj
  replacedByArticleId Int?      @map("replaced_by_article_id") // FK do artyku≈Çu zastƒôpujƒÖcego
  demandTransferredAt DateTime? @map("demand_transferred_at") // Data przeniesienia zapotrzebowania

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relacje
  location          OkucLocation?      @relation(fields: [locationId], references: [id])
  aliases           OkucArticleAlias[]
  proportionsSource OkucProportion[]   @relation("SourceArticle")
  proportionsTarget OkucProportion[]   @relation("TargetArticle")
  stocks            OkucStock[]
  demands           OkucDemand[]
  orderItems        OkucOrderItem[]
  historyEntries    OkucHistory[]

  // Self-relation dla zastƒôpstw
  replacedByArticle OkucArticle?  @relation("ArticleReplacement", fields: [replacedByArticleId], references: [id], onDelete: SetNull)
  replacesArticles  OkucArticle[] @relation("ArticleReplacement")

  @@index([usedInPvc])
  @@index([usedInAlu])
  @@index([orderClass, sizeClass])
  // Usuniƒôto @@index([articleId]) - duplikat (@unique automatycznie tworzy indeks)
  @@index([deletedAt])
  @@index([locationId])
  @@index([isPhaseOut])
  @@index([replacedByArticleId])
  @@map("okuc_articles")
}

// System alias√≥w - mapowanie starych numer√≥w na nowe
model OkucArticleAlias {
  id            Int       @id @default(autoincrement())
  articleId     Int       @map("article_id")
  aliasNumber   String    @unique @map("alias_number") // Stary numer
  isActive      Boolean   @default(true) @map("is_active") // false gdy zapas zszed≈Ç do 0
  deactivatedAt DateTime? @map("deactivated_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  article OkucArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([aliasNumber])
  @@index([isActive])
  @@index([articleId])
  @@map("okuc_article_aliases")
}

// Proporcje miƒôdzy artyku≈Çami (multiplier/split)
model OkucProportion {
  id              Int       @id @default(autoincrement())
  sourceArticleId Int       @map("source_article_id")
  targetArticleId Int       @map("target_article_id")
  proportionType  String    @map("proportion_type") // 'multiplier' | 'split'
  ratio           Float     @default(1.0) // np. 2.0 oznacza 2x target na 1x source
  splitPercent    Float?    @map("split_percent") // dla typu 'split' (0-100)
  tolerance       Float     @default(0.9) // tolerancja proporcji (np. 90%)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  sourceArticle OkucArticle @relation("SourceArticle", fields: [sourceArticleId], references: [id], onDelete: Cascade)
  targetArticle OkucArticle @relation("TargetArticle", fields: [targetArticleId], references: [id], onDelete: Cascade)

  @@unique([sourceArticleId, targetArticleId])
  @@index([sourceArticleId])
  @@index([targetArticleId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("okuc_proportions")
}

// Stan magazynowy okuƒá (PVC: 3 podmagazyny, ALU: jeden magazyn)
model OkucStock {
  id                  Int      @id @default(autoincrement())
  articleId           Int      @map("article_id")
  warehouseType       String   @map("warehouse_type") // 'pvc' | 'alu'
  subWarehouse        String?  @map("sub_warehouse") // 'production' | 'buffer' | 'gabaraty' (tylko PVC)
  currentQuantity     Int      @default(0) @map("current_quantity")
  initialQuantity     Int?     @map("initial_quantity") // Stan poczƒÖtkowy (remanent)
  isQuantityUncertain Boolean  @default(false) @map("is_quantity_uncertain") // Czy ilo≈õƒá jest niepewna (szare t≈Ço w raporcie)
  reservedQty         Int      @default(0) @map("reserved_qty")
  minStock            Int?     @map("min_stock")
  maxStock            Int?     @map("max_stock")
  version             Int      @default(0) // Optimistic locking
  updatedAt           DateTime @updatedAt @map("updated_at")
  updatedById         Int?     @map("updated_by_id")

  article   OkucArticle @relation(fields: [articleId], references: [id], onDelete: Restrict)
  updatedBy User?       @relation("OkucStockUpdatedBy", fields: [updatedById], references: [id])

  @@unique([articleId, warehouseType, subWarehouse])
  @@index([warehouseType])
  @@index([subWarehouse])
  @@index([articleId])
  @@map("okuc_stocks")
}

// Zapotrzebowanie na okucia (z CSV lub zlece≈Ñ)
model OkucDemand {
  id           Int     @id @default(autoincrement())
  demandId     String? @unique @map("demand_id") // ID z CSV importu (np. ZAP-2025-0089)
  articleId    Int     @map("article_id")
  orderId      Int?    @map("order_id") // PowiƒÖzanie ze zleceniem (opcjonalne)
  expectedWeek String  @map("expected_week") // Format: "2025-W02"
  quantity     Int
  status       String  @default("pending") // 'pending' | 'confirmed' | 'in_production' | 'completed' | 'cancelled'
  source       String  @default("order") // 'order' | 'csv_import'

  // Audit edycji rƒôcznej
  isManualEdit Boolean   @default(false) @map("is_manual_edit")
  editedAt     DateTime? @map("edited_at")
  editedById   Int?      @map("edited_by_id")
  editReason   String?   @map("edit_reason")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  article OkucArticle @relation(fields: [articleId], references: [id], onDelete: Restrict)
  order   Order?      @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([articleId])
  @@index([expectedWeek])
  @@index([status])
  @@index([orderId])
  @@index([source])
  @@index([expectedWeek, status])
  @@index([deletedAt])
  @@map("okuc_demands")
}

// Zam√≥wienie do dostawcy okuƒá
model OkucOrder {
  id                   Int       @id @default(autoincrement())
  orderNumber          String    @unique @map("order_number")
  basketType           String    @map("basket_type") // 'typical_standard' | 'typical_gabarat' | 'atypical'
  status               String    @default("draft") // 'draft' | 'pending' | 'ordered' | 'in_transit' | 'received' | 'cancelled'
  expectedDeliveryDate DateTime? @map("expected_delivery_date")
  actualDeliveryDate   DateTime? @map("actual_delivery_date")
  notes                String?

  // Audit edycji rƒôcznej
  isManualEdit Boolean   @default(false) @map("is_manual_edit")
  editedAt     DateTime? @map("edited_at")
  editedById   Int?      @map("edited_by_id")
  editReason   String?   @map("edit_reason")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  createdById Int?      @map("created_by_id")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  items     OkucOrderItem[]
  createdBy User?           @relation("OkucOrderCreatedBy", fields: [createdById], references: [id])

  @@index([basketType])
  @@index([status])
  @@index([expectedDeliveryDate])
  @@index([status, basketType])
  @@index([deletedAt])
  @@map("okuc_orders")
}

// Pozycja zam√≥wienia okuƒá
model OkucOrderItem {
  id          Int  @id @default(autoincrement())
  okucOrderId Int  @map("okuc_order_id")
  articleId   Int  @map("article_id")
  orderedQty  Int  @map("ordered_qty")
  receivedQty Int? @map("received_qty")
  unitPrice   Int? @map("unit_price") // Cena w groszach

  okucOrder OkucOrder   @relation(fields: [okucOrderId], references: [id], onDelete: Cascade)
  article   OkucArticle @relation(fields: [articleId], references: [id], onDelete: Restrict)

  @@unique([okucOrderId, articleId])
  @@index([okucOrderId])
  @@index([articleId])
  @@map("okuc_order_items")
}

// Historia zmian magazynowych okuƒá (RW, korekty, zwroty, remanent)
model OkucHistory {
  id            Int     @id @default(autoincrement())
  articleId     Int     @map("article_id")
  warehouseType String  @map("warehouse_type") // 'pvc' | 'alu'
  subWarehouse  String? @map("sub_warehouse")
  eventType     String  @map("event_type") // 'rw' | 'manual_consumption' | 'adjustment' | 'return' | 'inventory_count' | 'transfer' | 'order_received'
  previousQty   Int     @map("previous_qty")
  changeQty     Int     @map("change_qty") // Mo≈ºe byƒá ujemna
  newQty        Int     @map("new_qty")
  reason        String? // Wymagane dla adjustment i manual_consumption
  reference     String? // RW number, Order ID, itp.

  // Audit edycji rƒôcznej
  isManualEdit Boolean   @default(false) @map("is_manual_edit")
  editedAt     DateTime? @map("edited_at")
  editedById   Int?      @map("edited_by_id")

  // Timestamps
  recordedAt   DateTime @default(now()) @map("recorded_at")
  recordedById Int?     @map("recorded_by_id")

  article    OkucArticle @relation(fields: [articleId], references: [id], onDelete: Restrict)
  recordedBy User?       @relation("OkucHistoryRecordedBy", fields: [recordedById], references: [id])
  editedBy   User?       @relation("OkucHistoryEditedBy", fields: [editedById], references: [id])

  @@index([articleId])
  @@index([eventType])
  @@index([recordedAt])
  @@index([warehouseType])
  @@index([warehouseType, subWarehouse])
  @@index([isManualEdit])
  @@map("okuc_history")
}

// =============================================================================
// KATEGORYZOWANE SZYBY - Luzem, Aluminium, Reklamacyjne
// =============================================================================

// Typ kategorii szyb
// loose - szyby luzem (nr zam. klienta 9-11 cyfr lub bez d≈Çugiego numeru)
// aluminum - szyby aluminiowe (zawiera "AL.")
// reclamation - szyby reklamacyjne (zawiera "R/")

model LooseGlass {
  id                  Int      @id @default(autoincrement())
  glassDeliveryId     Int      @map("glass_delivery_id")
  customerOrderNumber String   @map("customer_order_number")
  clientName          String?  @map("client_name")
  widthMm             Int      @map("width_mm")
  heightMm            Int      @map("height_mm")
  quantity            Int
  orderNumber         String   @map("order_number")
  glassComposition    String?  @map("glass_composition")
  createdAt           DateTime @default(now()) @map("created_at")

  glassDelivery GlassDelivery @relation(fields: [glassDeliveryId], references: [id], onDelete: Cascade)

  @@index([customerOrderNumber])
  @@index([clientName])
  @@index([orderNumber])
  @@index([glassDeliveryId])
  @@map("loose_glasses")
}

model AluminumGlass {
  id                  Int      @id @default(autoincrement())
  glassDeliveryId     Int      @map("glass_delivery_id")
  customerOrderNumber String   @map("customer_order_number")
  clientName          String?  @map("client_name")
  widthMm             Int      @map("width_mm")
  heightMm            Int      @map("height_mm")
  quantity            Int
  orderNumber         String   @map("order_number")
  glassComposition    String?  @map("glass_composition")
  createdAt           DateTime @default(now()) @map("created_at")

  glassDelivery GlassDelivery @relation(fields: [glassDeliveryId], references: [id], onDelete: Cascade)

  @@index([customerOrderNumber])
  @@index([clientName])
  @@index([orderNumber])
  @@index([glassDeliveryId])
  @@map("aluminum_glasses")
}

model ReclamationGlass {
  id                  Int      @id @default(autoincrement())
  glassDeliveryId     Int      @map("glass_delivery_id")
  customerOrderNumber String   @map("customer_order_number")
  clientName          String?  @map("client_name")
  widthMm             Int      @map("width_mm")
  heightMm            Int      @map("height_mm")
  quantity            Int
  orderNumber         String   @map("order_number")
  glassComposition    String?  @map("glass_composition")
  createdAt           DateTime @default(now()) @map("created_at")

  glassDelivery GlassDelivery @relation(fields: [glassDeliveryId], references: [id], onDelete: Cascade)

  @@index([customerOrderNumber])
  @@index([clientName])
  @@index([orderNumber])
  @@index([glassDeliveryId])
  @@map("reclamation_glasses")
}

// ============================================
// Weryfikacja list dostaw Akrobud
// ============================================

model AkrobudVerificationList {
  id           Int       @id @default(autoincrement())
  deliveryDate DateTime  @map("delivery_date")
  deliveryId   Int?      @map("delivery_id")
  title        String?
  notes        String?
  status       String    @default("draft") // draft | verified | applied
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Wersjonowanie list
  version       Int       @default(1) // Numer wersji listy (v1, v2, v3...)
  parentId      Int?      @map("parent_id") // ID poprzedniej wersji
  rawInput      String?   @map("raw_input") // Oryginalny tekst maila
  suggestedDate DateTime? @map("suggested_date") // Wykryta data z "na DD.MM"

  delivery Delivery?                 @relation(fields: [deliveryId], references: [id])
  items    AkrobudVerificationItem[]
  parent   AkrobudVerificationList?  @relation("ListVersions", fields: [parentId], references: [id])
  children AkrobudVerificationList[] @relation("ListVersions")

  @@index([deliveryDate])
  @@index([deletedAt])
  @@index([status])
  @@index([parentId])
  @@index([version])
  @@map("akrobud_verification_lists")
}

model AkrobudVerificationItem {
  id                Int      @id @default(autoincrement())
  listId            Int      @map("list_id")
  orderNumberInput  String   @map("order_number_input") // Legacy: numer zlecenia
  orderNumberBase   String?  @map("order_number_base") // Legacy
  orderNumberSuffix String?  @map("order_number_suffix") // Legacy
  matchedOrderId    Int?     @map("matched_order_id") // Legacy: pojedyncze zlecenie
  matchStatus       String   @default("pending") @map("match_status") // pending | found | not_found | variant_match
  position          Int
  createdAt         DateTime @default(now()) @map("created_at")

  // Nowe pola dla projekt√≥w
  projectNumber String? @map("project_number") // Numer projektu (np. "D3455")

  list          AkrobudVerificationList @relation(fields: [listId], references: [id], onDelete: Cascade)
  matchedOrder  Order?                  @relation(fields: [matchedOrderId], references: [id])
  matchedOrders VerificationItemOrder[] // Relacja 1:N - projekt mo≈ºe mieƒá wiele zlece≈Ñ

  @@unique([listId, orderNumberInput])
  @@index([listId])
  @@index([matchStatus])
  @@index([projectNumber])
  @@map("akrobud_verification_items")
}

// Tabela ≈ÇƒÖczƒÖca projekty z zleceniami (relacja N:M)
model VerificationItemOrder {
  id      Int @id @default(autoincrement())
  itemId  Int @map("item_id")
  orderId Int @map("order_id")

  item  AkrobudVerificationItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  order Order                   @relation(fields: [orderId], references: [id])

  @@unique([itemId, orderId])
  @@index([itemId])
  @@index([orderId])
  @@map("verification_item_orders")
}

// =============================================================================
// TIMESHEETS MODULE - Godzin√≥wki produkcyjne
// =============================================================================

// Pracownik produkcyjny
model Worker {
  id              Int      @id @default(autoincrement())
  firstName       String   @map("first_name")
  lastName        String   @map("last_name")
  defaultPosition String   @map("default_position") // Domy≈õlne stanowisko
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  timeEntries TimeEntry[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("workers")
}

// Stanowisko pracy (s≈Çownik edytowalny)
model Position {
  id        Int      @id @default(autoincrement())
  name      String   @unique // "Ciƒôcie", "Zbrojenie", "Spawanie", etc.
  shortName String?  @map("short_name") // Skr√≥cona nazwa do wy≈õwietlania
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  timeEntries TimeEntry[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("positions")
}

// Typ zadania nieprodukcyjnego (s≈Çownik edytowalny)
model NonProductiveTaskType {
  id        Int      @id @default(autoincrement())
  name      String   @unique // "Serwis", "Pakowanie", "Przygotowywanie profili", etc.
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tasks NonProductiveTask[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("non_productive_task_types")
}

// Wpis godzinowy pracownika na dany dzie≈Ñ
model TimeEntry {
  id              Int      @id @default(autoincrement())
  date            DateTime // Data wpisu (przechowywana jako DateTime, u≈ºywana jako Date)
  workerId        Int      @map("worker_id")
  positionId      Int      @map("position_id") // Stanowisko w tym dniu
  productiveHours Float    @default(0) @map("productive_hours") // Godziny produktywne (0.0 - 24.0)
  absenceType     String?  @map("absence_type") // Typ nieobecno≈õci: "SICK" | "VACATION" | "ABSENT" | null
  notes           String? // Notatki do wpisu
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  worker             Worker              @relation(fields: [workerId], references: [id], onDelete: Restrict)
  position           Position            @relation(fields: [positionId], references: [id], onDelete: Restrict)
  nonProductiveTasks NonProductiveTask[]
  specialWorks       SpecialWork[]

  @@unique([date, workerId]) // Jeden wpis na pracownika na dzie≈Ñ
  @@index([date])
  @@index([workerId])
  @@index([positionId])
  // Usuniƒôto @@index([date, workerId]) - duplikat (@@unique automatycznie tworzy indeks)
  @@index([absenceType])
  @@map("time_entries")
}

// Zadanie nieprodukcyjne przypisane do wpisu godzinowego
model NonProductiveTask {
  id          Int      @id @default(autoincrement())
  timeEntryId Int      @map("time_entry_id")
  taskTypeId  Int      @map("task_type_id")
  hours       Float    @map("hours") // Godziny (0.0 - 24.0)
  notes       String? // Opcjonalne notatki
  createdAt   DateTime @default(now()) @map("created_at")

  timeEntry TimeEntry             @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  taskType  NonProductiveTaskType @relation(fields: [taskTypeId], references: [id], onDelete: Restrict)

  @@index([timeEntryId])
  @@index([taskTypeId])
  @@map("non_productive_tasks")
}

// Typ nietyp√≥wki (s≈Çownik edytowalny) - Drzwi, HS, PSK, szprosy, trapez
model SpecialWorkType {
  id        Int      @id @default(autoincrement())
  name      String   @unique // "Drzwi", "HS", "PSK", etc.
  shortName String?  @map("short_name")
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  specialWorks SpecialWork[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("special_work_types")
}

// Nietyp√≥wka przypisana do wpisu godzinowego
model SpecialWork {
  id            Int      @id @default(autoincrement())
  timeEntryId   Int      @map("time_entry_id")
  specialTypeId Int      @map("special_type_id")
  hours         Float    @map("hours") // Godziny (0.0 - 24.0)
  notes         String? // Opcjonalne notatki
  createdAt     DateTime @default(now()) @map("created_at")

  timeEntry   TimeEntry       @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  specialType SpecialWorkType @relation(fields: [specialTypeId], references: [id], onDelete: Restrict)

  @@index([timeEntryId])
  @@index([specialTypeId])
  @@map("special_works")
}

// =============================================================================
// PALLET STOCK MODULE - Palet√≥wki (zarzƒÖdzanie stanem palet produkcyjnych)
// =============================================================================

// Typy palet produkcyjnych (jako String bo SQLite nie wspiera enum):
// 'MALA' | 'P2400' | 'P3000' | 'P3500' | 'P4000'

// Status dnia paletowego (jako String):
// 'OPEN' - otwarty, mo≈ºna edytowaƒá
// 'CLOSED' - zamkniƒôty, tylko podglƒÖd

// Dzie≈Ñ paletowy - g≈Ç√≥wna encja modu≈Çu
model PalletStockDay {
  id        Int       @id @default(autoincrement())
  date      DateTime  @unique // Data (tylko dzie≈Ñ, bez czasu)
  status    String    @default("OPEN") // 'OPEN' | 'CLOSED'
  closedAt  DateTime? @map("closed_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  entries PalletStockEntry[]

  @@index([date])
  @@index([status])
  @@map("pallet_stock_days")
}

// Wpis dla typu palety w danym dniu
model PalletStockEntry {
  id               Int      @id @default(autoincrement())
  palletDayId      Int      @map("pallet_day_id")
  type             String // 'MALA' | 'P2400' | 'P3000' | 'P3500' | 'P4000'
  morningStock     Int      @default(0) @map("morning_stock") // Stan poranny
  morningCorrected Boolean  @default(false) @map("morning_corrected") // Czy by≈Ça korekta
  morningNote      String?  @map("morning_note") // Komentarz do korekty (wymagany gdy corrected=true)
  used             Int      @default(0) // U≈ºyte w ciƒÖgu dnia
  produced         Int      @default(0) // Zrobione wieczorem
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  palletDay PalletStockDay @relation(fields: [palletDayId], references: [id], onDelete: Cascade)

  @@unique([palletDayId, type])
  @@index([type])
  @@map("pallet_stock_entries")
}

// Konfiguracja alert√≥w (progi krytyczne per typ palety)
model PalletAlertConfig {
  id                Int      @id @default(autoincrement())
  type              String   @unique // 'MALA' | 'P2400' | 'P3000' | 'P3500' | 'P4000'
  criticalThreshold Int      @default(10) @map("critical_threshold") // Pr√≥g alertu
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("pallet_alert_configs")
}

// Stan poczƒÖtkowy palet - jeden rekord globalny okre≈õlajƒÖcy od kiedy liczymy i ile by≈Ço na start
model PalletInitialStock {
  id           Int      @id @default(autoincrement())
  startDate    DateTime @map("start_date") // Data od kt√≥rej system liczy (wsp√≥lna dla wszystkich typ√≥w)
  type         String   @unique // 'MALA' | 'P2400' | 'P3000' | 'P3500' | 'P4000'
  initialStock Int      @default(0) @map("initial_stock") // PoczƒÖtkowa ilo≈õƒá palet
  updatedAt    DateTime @updatedAt @map("updated_at")
  updatedById  Int?     @map("updated_by_id") // Kto ostatnio modyfikowa≈Ç

  updatedBy User? @relation("PalletInitialStockUpdatedBy", fields: [updatedById], references: [id])

  @@map("pallet_initial_stocks")
}

// =============================================================================
// ZESTAWIENIE MIESIƒòCZNE PRODUKCJI
// =============================================================================

// G≈Ç√≥wny raport miesiƒôczny produkcji
// Zastƒôpuje stary MonthlyReport - oparty o productionDate zamiast invoiceNumber
model ProductionReport {
  id    Int @id @default(autoincrement())
  year  Int
  month Int

  // Status zamkniƒôcia: 'open' | 'closed'
  status     String    @default("open")
  closedAt   DateTime? @map("closed_at")
  closedById Int?      @map("closed_by_id")

  // Znacznik edycji po zamkniƒôciu (bez pe≈Çnej historii)
  editedAfterClose Boolean   @default(false) @map("edited_after_close")
  reopenedAt       DateTime? @map("reopened_at")
  reopenedById     Int?      @map("reopened_by_id")

  // Nietyp√≥wki (korekta raportowa - jedna globalna na miesiƒÖc)
  atypicalWindows  Int     @default(0) @map("atypical_windows")
  atypicalUnits    Int     @default(0) @map("atypical_units")
  atypicalSashes   Int     @default(0) @map("atypical_sashes")
  atypicalValuePln Int     @default(0) @map("atypical_value_pln") // w groszach
  atypicalCurrency String  @default("PLN") @map("atypical_currency")
  atypicalNotes    String? @map("atypical_notes")

  // Audit timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacje
  closedBy   User?                  @relation("ProductionReportClosedBy", fields: [closedById], references: [id])
  reopenedBy User?                  @relation("ProductionReportReopenedBy", fields: [reopenedById], references: [id])
  items      ProductionReportItem[]

  @@unique([year, month])
  // Usuniƒôto @@index([year, month]) - duplikat (@@unique automatycznie tworzy indeks)
  @@index([status])
  @@map("production_reports")
}

// Pozycja raportu - nadpisane warto≈õci dla zlecenia
// Tylko zlecenia z productionDate w danym miesiƒÖcu i status=completed
model ProductionReportItem {
  id       Int @id @default(autoincrement())
  reportId Int @map("report_id")
  orderId  Int @map("order_id")

  // Nadpisane warto≈õci (je≈õli kierownik edytowa≈Ç) - NULL = u≈ºyj warto≈õci z Order
  overrideWindows  Int? @map("override_windows")
  overrideUnits    Int? @map("override_units")
  overrideSashes   Int? @map("override_sashes")
  overrideValuePln Int? @map("override_value_pln") // w groszach
  overrideValueEur Int? @map("override_value_eur") // w centach
  overrideMaterialValue Int? @map("override_material_value") // w groszach (nadpisanie warto≈õci materia≈Çu)

  // Checkboxy RW (Rozch√≥d Wewnƒôtrzny - czy materia≈Çy wydane z magazynu)
  rwOkucia  Boolean @default(false) @map("rw_okucia")
  rwProfile Boolean @default(false) @map("rw_profile")

  // Dane FV (edytowalne przez ksiƒôgowƒÖ nawet po zamkniƒôciu miesiƒÖca)
  invoiceNumber String?   @map("invoice_number")
  invoiceDate   DateTime? @map("invoice_date")

  // Audit timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacje
  report ProductionReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  order  Order            @relation("ProductionReportItems", fields: [orderId], references: [id], onDelete: Restrict)

  @@unique([reportId, orderId])
  @@index([reportId])
  @@index([orderId])
  @@map("production_report_items")
}

// =============================================================================
// PENDING IMPORT CONFLICTS - Konflikty importu oczekujƒÖce na rozwiƒÖzanie
// =============================================================================

// Konflikt importu - plik z wariantem zlecenia (np. 53455-b) gdy bazowe istnieje
model PendingImportConflict {
  id Int @id @default(autoincrement())

  // Dane zlecenia z pliku
  orderNumber     String @map("order_number") // Pe≈Çny numer (np. "53455-b")
  baseOrderNumber String @map("base_order_number") // Bazowy numer (np. "53455")
  suffix          String // Sufiks (np. "b")

  // PowiƒÖzanie z bazowym zleceniem
  baseOrderId Int   @map("base_order_id")
  baseOrder   Order @relation("ConflictBaseOrder", fields: [baseOrderId], references: [id], onDelete: Cascade)

  // PowiƒÖzanie z autorem (pracownikiem)
  documentAuthor String? @map("document_author") // Nazwa autora z CSV
  authorUserId   Int?    @map("author_user_id") // Przypisany user
  authorUser     User?   @relation("ConflictAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)

  // Plik ≈∫r√≥d≈Çowy
  filepath String // ≈öcie≈ºka do skopiowanego pliku
  filename String // Oryginalna nazwa pliku

  // Parsowane dane z CSV (JSON) - do por√≥wnania i p√≥≈∫niejszego importu
  parsedData String @map("parsed_data")

  // Dane por√≥wnawcze (cache)
  existingWindowsCount Int? @map("existing_windows_count")
  existingGlassCount   Int? @map("existing_glass_count")
  newWindowsCount      Int? @map("new_windows_count")
  newGlassCount        Int? @map("new_glass_count")

  // Sugestia systemu: 'replace_base' | 'keep_both' | 'manual'
  systemSuggestion String? @map("system_suggestion")

  // Status: 'pending' | 'resolved' | 'cancelled'
  status String @default("pending")

  // RozwiƒÖzanie: 'replaced' | 'kept_both' | 'cancelled'
  resolution   String?   @map("resolution")
  resolvedAt   DateTime? @map("resolved_at")
  resolvedById Int?      @map("resolved_by_id")
  resolvedBy   User?     @relation("ConflictResolver", fields: [resolvedById], references: [id], onDelete: SetNull)

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([authorUserId])
  @@index([baseOrderId])
  @@index([createdAt])
  @@index([status, authorUserId])
  @@map("pending_import_conflicts")
}

// ============================================================================
// PLANOWANIE PRODUKCJI - dodane 2026-01-15
// ============================================================================

// Konfiguracja wydajno≈õci per typ klienta
// Wydajno≈õƒá bazowa: szkle≈Ñ/h i skrzyde≈Ç/h przy pe≈Çnej obsadzie
model ProductionEfficiencyConfig {
  id              Int      @id @default(autoincrement())
  clientType      String   @unique @map("client_type") // 'akrobud' | 'ct' | 'living' | 'other'
  name            String // Nazwa wy≈õwietlana (np. "Akrobud", "CT", "Living")
  // Wydajno≈õƒá bazowa
  glazingsPerHour Decimal  @map("glazings_per_hour") // Szkle≈Ñ na godzinƒô produkcyjnƒÖ
  wingsPerHour    Decimal  @map("wings_per_hour") // Skrzyde≈Ç na godzinƒô produkcyjnƒÖ
  // Wsp√≥≈Çczynnik (1.0 = baza, <1.0 = wolniejsze, >1.0 = szybsze)
  coefficient     Decimal  @default(1.0) // Wsp√≥≈Çczynnik wydajno≈õci
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("production_efficiency_configs")
}

// Kalendarz produkcyjny - dni wolne i soboty produkcyjne
model ProductionCalendar {
  id          Int      @id @default(autoincrement())
  date        DateTime @unique // Data (bez czasu)
  dayType     String   @map("day_type") // 'working' | 'holiday' | 'production_saturday' | 'custom_off'
  description String? // Opis (np. "Nowy Rok", "Sobota produkcyjna")
  maxHours    Decimal? @map("max_hours") // Max godzin w tym dniu (null = domy≈õlne)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("production_calendar")
}

// Domy≈õlne parametry planowania produkcji
model ProductionSettings {
  id          Int      @id @default(autoincrement())
  key         String   @unique // Klucz parametru
  value       String // Warto≈õƒá (jako JSON string dla z≈Ço≈ºonych)
  description String? // Opis parametru
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("production_settings")
}

// =============================================================================
// STEEL MODULE - Wzmocnienia stalowe (rozpoznawane po nr artyku≈Çu 201xxx, 202xxx)
// =============================================================================

// Stal - wzmocnienie stalowe (bez kolor√≥w, w odr√≥≈ºnieniu od profili PVC)
model Steel {
  id            Int      @id @default(autoincrement())
  number        String   @unique // Numer stali bez ko≈Ñcowego "00" (np. "201202", "202617")
  articleNumber String?  @unique @map("article_number") // Pe≈Çny numer artyku≈Çu (np. "20120200")
  name          String // Nazwa (np. "Wzmocnienie 1.5 do ramy 8864")
  description   String?
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relacje
  steelStock             SteelStock[]
  steelOrders            SteelOrder[]
  steelHistory           SteelHistory[]
  orderSteelRequirements OrderSteelRequirement[]

  @@map("steels")
}

// Stan magazynowy stali (bez kolor√≥w - jeden rekord na stal)
model SteelStock {
  id                Int       @id @default(autoincrement())
  steelId           Int       @unique @map("steel_id")
  currentStockBeams Int       @default(0) @map("current_stock_beams")
  initialStockBeams Int       @default(0) @map("initial_stock_beams")
  version           Int       @default(0) // Optimistic locking
  deletedAt         DateTime? @map("deleted_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  updatedById       Int?      @map("updated_by_id")

  steel     Steel @relation(fields: [steelId], references: [id], onDelete: Restrict)
  updatedBy User? @relation("SteelStockUpdatedBy", fields: [updatedById], references: [id])

  @@index([deletedAt])
  @@map("steel_stock")
}

// Zam√≥wienie stali do dostawcy
model SteelOrder {
  id                   Int      @id @default(autoincrement())
  steelId              Int      @map("steel_id")
  orderedBeams         Int      @map("ordered_beams")
  expectedDeliveryDate DateTime @map("expected_delivery_date")
  status               String   @default("pending") // pending | ordered | delivered | cancelled
  notes                String?
  createdAt            DateTime @default(now()) @map("created_at")
  createdById          Int?     @map("created_by_id")

  steel     Steel @relation(fields: [steelId], references: [id], onDelete: Restrict)
  createdBy User? @relation("SteelOrderCreatedBy", fields: [createdById], references: [id])

  @@unique([steelId, expectedDeliveryDate])
  @@index([status])
  @@map("steel_orders")
}

// Historia zmian magazynowych stali
model SteelHistory {
  id              Int      @id @default(autoincrement())
  steelId         Int      @map("steel_id")
  calculatedStock Int      @map("calculated_stock")
  actualStock     Int      @map("actual_stock")
  difference      Int
  previousStock   Int?     @map("previous_stock")
  currentStock    Int?     @map("current_stock")
  changeType      String?  @map("change_type") // adjustment | inventory_count | order_received
  notes           String?
  recordedAt      DateTime @default(now()) @map("recorded_at")
  recordedById    Int?     @map("recorded_by_id")

  steel      Steel @relation(fields: [steelId], references: [id], onDelete: Restrict)
  recordedBy User? @relation("SteelHistoryRecordedBy", fields: [recordedById], references: [id])

  @@index([steelId])
  @@index([recordedAt])
  @@map("steel_history")
}

// Zapotrzebowanie na stal z zam√≥wienia produkcyjnego (analogicznie do OrderRequirement dla profili)
model OrderSteelRequirement {
  id         Int      @id @default(autoincrement())
  orderId    Int      @map("order_id")
  steelId    Int      @map("steel_id")
  beamsCount Int      @map("beams_count")
  meters     Float
  restMm     Int      @map("rest_mm")
  status     String   @default("pending") // pending | completed (dla RW)
  createdAt  DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  steel Steel @relation(fields: [steelId], references: [id], onDelete: Restrict)

  @@unique([orderId, steelId])
  @@index([steelId])
  @@index([status])
  @@map("order_steel_requirements")
}

// =============================================================================
// LABEL CHECK MODULE - Kontrola etykiet na paczkach
// =============================================================================

// Sprawdzenie etykiet dla dostawy
model LabelCheck {
  id            Int       @id @default(autoincrement())
  deliveryId    Int       @map("delivery_id")
  deliveryDate  DateTime  @map("delivery_date")
  status        String    @default("pending") // 'pending' | 'completed' | 'failed'
  totalOrders   Int       @default(0) @map("total_orders")
  checkedCount  Int       @default(0) @map("checked_count")
  okCount       Int       @default(0) @map("ok_count")
  mismatchCount Int       @default(0) @map("mismatch_count")
  errorCount    Int       @default(0) @map("error_count")
  createdAt     DateTime  @default(now()) @map("created_at")
  completedAt   DateTime? @map("completed_at")
  deletedAt     DateTime? @map("deleted_at")

  delivery Delivery           @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  results  LabelCheckResult[]

  @@index([deliveryId])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("label_checks")
}

// Wynik sprawdzenia etykiety dla pojedynczego zlecenia
model LabelCheckResult {
  id           Int       @id @default(autoincrement())
  labelCheckId Int       @map("label_check_id")
  orderId      Int       @map("order_id")
  orderNumber  String    @map("order_number")
  status       String // 'OK' | 'MISMATCH' | 'NO_FOLDER' | 'NO_BMP' | 'OCR_ERROR'
  expectedDate DateTime  @map("expected_date")
  detectedDate DateTime? @map("detected_date")
  detectedText String?   @map("detected_text")
  imagePath    String?   @map("image_path")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")

  labelCheck LabelCheck @relation(fields: [labelCheckId], references: [id], onDelete: Cascade)

  @@index([labelCheckId])
  @@index([orderId])
  @@index([status])
  @@map("label_check_results")
}

// ============================================================================
// MODU≈Å LOGISTYKI - Parsowanie maili z listami dostaw od Akrobud
// ============================================================================

// Lista mailowa - reprezentuje jeden mail z listƒÖ projekt√≥w na dostawƒô
// Ka≈ºda aktualizacja listy tworzy nowƒÖ wersjƒô (v1, v2, v3...)
model LogisticsMailList {
  id            Int       @id @default(autoincrement())
  deliveryDate  DateTime  @map("delivery_date") // Data dostawy (np. 2026-02-16)
  deliveryIndex Int       @map("delivery_index") // Index dostawy (_I = 1, _II = 2, _III = 3)
  deliveryCode  String    @map("delivery_code") // Kod dostawy np. "16.02.2026_I"
  version       Int       @default(1) // Wersja listy (v1, v2, v3...)
  isUpdate      Boolean   @default(false) @map("is_update") // Czy to aktualizacja (vs nowa lista)
  rawMailText   String    @map("raw_mail_text") // Oryginalny tekst maila
  parsedAt      DateTime  @default(now()) @map("parsed_at") // Kiedy sparsowano
  createdAt     DateTime  @default(now()) @map("created_at")
  deletedAt     DateTime? @map("deleted_at") // Soft delete

  // PowiƒÖzanie z dostawƒÖ (auto-linking po dacie lub rƒôczne)
  deliveryId Int?      @map("delivery_id")
  delivery   Delivery? @relation(fields: [deliveryId], references: [id], onDelete: SetNull)

  items LogisticsMailItem[]

  @@unique([deliveryCode, version]) // Unikalno≈õƒá: kod dostawy + wersja
  @@index([deliveryDate])
  @@index([deliveryCode])
  @@index([deletedAt])
  @@index([deliveryId])
  @@map("logistics_mail_lists")
}

// Pozycja z maila - jeden projekt na li≈õcie
model LogisticsMailItem {
  id            Int     @id @default(autoincrement())
  mailListId    Int     @map("mail_list_id")
  position      Int // Kolejno≈õƒá na li≈õcie (Lp.)
  projectNumber String  @map("project_number") // Numer projektu (D6086, C8748)
  quantity      Int     @default(1) // Ilo≈õƒá (x2 = 2)
  rawNotes      String? @map("raw_notes") // Oryginalne adnotacje z maila
  requiresMesh  Boolean @default(false) @map("requires_mesh") // Flaga: poproszƒô o siatkƒô

  // Flagi blokujƒÖce - powodujƒÖ status 'blocked'
  missingFile           Boolean @default(false) @map("missing_file") // brak pliku
  unconfirmed           Boolean @default(false) // niepotwierdzone
  dimensionsUnconfirmed Boolean @default(false) @map("dimensions_unconfirmed") // wymiary niepotwierdzone
  drawingUnconfirmed    Boolean @default(false) @map("drawing_unconfirmed") // rysunek niepotwierdzony

  // Flagi specjalne
  excludeFromProduction Boolean @default(false) @map("exclude_from_production") // bez okna
  specialHandle         Boolean @default(false) @map("special_handle") // klamka alu z kluczem
  customColor           String? @map("custom_color") // RAL XXXX (je≈õli wykryto)

  // PowiƒÖzanie z Order (nullable - mo≈ºe nie istnieƒá w bazie)
  orderId Int?   @map("order_id")
  order   Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Status wyliczany: ok | blocked | waiting | excluded
  // blocked = missingFile OR unconfirmed OR dimensionsUnconfirmed OR drawingUnconfirmed
  // waiting = requiresMesh AND NOT blocked
  // excluded = excludeFromProduction
  // ok = brak flag
  itemStatus String @default("ok") @map("item_status")

  // Metadata dla systemu decyzji diff
  confirmedAt DateTime? @map("confirmed_at") // Kiedy u≈ºytkownik potwierdzi≈Ç pozycjƒô
  deletedAt   DateTime? @map("deleted_at") // Soft delete - pozycja usuniƒôta przez u≈ºytkownika

  mailList LogisticsMailList @relation(fields: [mailListId], references: [id], onDelete: Cascade)

  // Relacja do log√≥w decyzji
  decisionLogs LogisticsDecisionLog[]

  @@index([mailListId])
  @@index([projectNumber])
  @@index([orderId])
  @@index([itemStatus])
  @@map("logistics_mail_items")
}

// Log decyzji u≈ºytkownika - AUDYT
// Zapisuje kto, kiedy, co zrobi≈Ç z pozycjƒÖ/dostawƒÖ
// Pozwala odtworzyƒá historiƒô zmian i rozstrzygaƒá spory
model LogisticsDecisionLog {
  id Int @id @default(autoincrement())

  // Typ encji: 'item' (pozycja) lub 'delivery' (ca≈Ça lista/dostawa)
  entityType String @map("entity_type") // 'item' | 'delivery'
  entityId   Int    @map("entity_id") // ID pozycji lub listy

  // Akcja podjƒôta przez u≈ºytkownika
  // item: confirm | reject | remove | accept_change | restore
  // delivery: save | delete
  action String // confirm | reject | remove | accept_change | restore | save | delete

  // Kontekst wersji (dla diff)
  fromVersion Int? @map("from_version") // Z kt√≥rej wersji (null dla nowych)
  toVersion   Int? @map("to_version") // Do kt√≥rej wersji

  // Dodatkowe dane (JSON) - np. co dok≈Çadnie siƒô zmieni≈Ço
  // Dla restore: { field: "quantity", oldValue: "1", newValue: "2" }
  // Dla confirm: { projectNumber: "D6086" }
  metadata String? // JSON string z dodatkowymi danymi

  // Kto podjƒÖ≈Ç decyzjƒô
  userId Int  @map("user_id")
  user   User @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Kiedy
  createdAt DateTime @default(now()) @map("created_at")

  // Opcjonalna relacja do pozycji (tylko dla entityType='item')
  mailItemId Int?               @map("mail_item_id")
  mailItem   LogisticsMailItem? @relation(fields: [mailItemId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("logistics_decision_logs")
}
