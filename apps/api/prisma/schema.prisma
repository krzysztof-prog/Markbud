generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                 @id @default(autoincrement())
  email                  String              @unique
  passwordHash           String              @map("password_hash")
  name                   String
  role                   String              @default("user")
  createdAt              DateTime            @default(now()) @map("created_at")
  updatedAt              DateTime            @updatedAt @map("updated_at")
  notes                  Note[]
  warehouseHistory       WarehouseHistory[]  @relation("RecordedBy")
  warehouseOrdersCreated WarehouseOrder[]    @relation("WarehouseOrderCreatedBy")
  warehouseUpdates       WarehouseStock[]    @relation("UpdatedBy")
  folderSettings         UserFolderSettings?
  importLocks            ImportLock[]
  // DualStock (Okuc) relations
  okucStockUpdates       OkucStock[]         @relation("OkucStockUpdatedBy")
  okucOrdersCreated      OkucOrder[]         @relation("OkucOrderCreatedBy")
  okucHistoryRecorded    OkucHistory[]       @relation("OkucHistoryRecordedBy")
  okucHistoryEdited      OkucHistory[]       @relation("OkucHistoryEditedBy")

  @@map("users")
}

model Profile {
  id                Int                @id @default(autoincrement())
  number            String             @unique
  articleNumber     String?            @unique @map("article_number")
  name              String
  description       String?
  sortOrder         Int                @default(0) @map("sort_order")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  orderRequirements OrderRequirement[]
  profileColors     ProfileColor[]
  warehouseHistory  WarehouseHistory[]
  warehouseOrders   WarehouseOrder[]
  warehouseStock    WarehouseStock[]

  @@map("profiles")
}

model Color {
  id                Int                @id @default(autoincrement())
  code              String             @unique
  name              String
  type              String
  hexColor          String?            @map("hex_color")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  orderRequirements OrderRequirement[]
  profileColors     ProfileColor[]
  warehouseHistory  WarehouseHistory[]
  warehouseOrders   WarehouseOrder[]
  warehouseStock    WarehouseStock[]

  @@map("colors")
}

model ProfileColor {
  id        Int     @id @default(autoincrement())
  profileId Int     @map("profile_id")
  colorId   Int     @map("color_id")
  isVisible Boolean @default(true) @map("is_visible")
  color     Color   @relation(fields: [colorId], references: [id], onDelete: Cascade)
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, colorId])
  @@map("profile_colors")
}

model Order {
  id                  Int                 @id @default(autoincrement())
  orderNumber         String              @unique @map("order_number")
  status              String              @default("new")
  client              String?
  project             String?
  system              String?
  deadline            DateTime?
  pvcDeliveryDate     DateTime?           @map("pvc_delivery_date")
  valuePln            Int?                @map("value_pln")
  valueEur            Int?                @map("value_eur")
  invoiceNumber       String?             @map("invoice_number")
  deliveryDate        DateTime?           @map("delivery_date")
  productionDate      DateTime?           @map("production_date")
  glassDeliveryDate   DateTime?           @map("glass_delivery_date")
  notes               String?
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  archivedAt          DateTime?           @map("archived_at")
  totalGlasses        Int?                @map("total_glasses")
  totalSashes         Int?                @map("total_sashes")
  totalWindows        Int?                @map("total_windows")
  completedAt         DateTime?           @map("completed_at")
  orderedGlassCount   Int?                @default(0) @map("ordered_glass_count")
  deliveredGlassCount Int?                @default(0) @map("delivered_glass_count")
  glassOrderStatus    String?             @default("not_ordered") @map("glass_order_status")
  deliveryOrders      DeliveryOrder[]
  glassOrderItems     GlassOrderItem[]
  monthlyReportItems  MonthlyReportItem[]
  orderNotes          Note[]
  requirements        OrderRequirement[]
  windows             OrderWindow[]
  schucoLinks         OrderSchucoLink[]
  okucDemands         OkucDemand[]

  @@index([status])
  @@index([archivedAt])
  @@index([createdAt])
  @@index([invoiceNumber, createdAt])
  @@index([invoiceNumber, deliveryDate])
  @@index([status, archivedAt])
  @@index([glassOrderStatus])
  @@index([deliveryDate, status])
  @@map("orders")
}

model OrderRequirement {
  id         Int      @id @default(autoincrement())
  orderId    Int      @map("order_id")
  profileId  Int      @map("profile_id")
  colorId    Int      @map("color_id")
  beamsCount Int      @map("beams_count")
  meters     Float
  restMm     Int      @map("rest_mm")
  createdAt  DateTime @default(now()) @map("created_at")
  color      Color    @relation(fields: [colorId], references: [id], onDelete: Restrict)
  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Restrict)
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, profileId, colorId])
  @@index([colorId])
  @@index([profileId])
  @@index([createdAt])
  @@map("order_requirements")
}

model OrderWindow {
  id          Int      @id @default(autoincrement())
  orderId     Int      @map("order_id")
  widthMm     Int      @map("width_mm")
  heightMm    Int      @map("height_mm")
  profileType String   @map("profile_type")
  quantity    Int
  reference   String?
  createdAt   DateTime @default(now()) @map("created_at")
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([profileType])
  @@map("order_windows")
}

model WarehouseStock {
  id                  Int       @id @default(autoincrement())
  profileId           Int       @map("profile_id")
  colorId             Int       @map("color_id")
  currentStockBeams   Int       @default(0) @map("current_stock_beams")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  updatedById         Int?      @map("updated_by_id")
  initialStockBeams   Int       @default(0) @map("initial_stock_beams")
  version             Int       @default(0)
  deletedAt           DateTime? @map("deleted_at")
  updatedBy           User?     @relation("UpdatedBy", fields: [updatedById], references: [id])
  color               Color     @relation(fields: [colorId], references: [id], onDelete: Restrict)
  profile             Profile   @relation(fields: [profileId], references: [id], onDelete: Restrict)

  @@unique([profileId, colorId])
  @@index([deletedAt])
  @@map("warehouse_stock")
}

model WarehouseOrder {
  id                   Int      @id @default(autoincrement())
  profileId            Int      @map("profile_id")
  colorId              Int      @map("color_id")
  orderedBeams         Int      @map("ordered_beams")
  expectedDeliveryDate DateTime @map("expected_delivery_date")
  status               String   @default("pending")
  notes                String?
  createdAt            DateTime @default(now()) @map("created_at")
  createdById          Int?     @map("created_by_id")
  createdBy            User?    @relation("WarehouseOrderCreatedBy", fields: [createdById], references: [id])
  color                Color    @relation(fields: [colorId], references: [id], onDelete: Restrict)
  profile              Profile  @relation(fields: [profileId], references: [id], onDelete: Restrict)

  @@unique([profileId, colorId, expectedDeliveryDate])
  @@index([status])
  @@index([expectedDeliveryDate])
  @@map("warehouse_orders")
}

model WarehouseHistory {
  id              Int      @id @default(autoincrement())
  profileId       Int      @map("profile_id")
  colorId         Int      @map("color_id")
  calculatedStock Int      @map("calculated_stock")
  actualStock     Int      @map("actual_stock")
  difference      Int
  previousStock   Int?     @map("previous_stock")
  currentStock    Int?     @map("current_stock")
  changeType      String?  @map("change_type")
  notes           String?
  recordedAt      DateTime @default(now()) @map("recorded_at")
  recordedById    Int?     @map("recorded_by_id")
  recordedBy      User?    @relation("RecordedBy", fields: [recordedById], references: [id])
  color           Color    @relation(fields: [colorId], references: [id], onDelete: Restrict)
  profile         Profile  @relation(fields: [profileId], references: [id], onDelete: Restrict)

  @@index([colorId])
  @@index([profileId])
  @@index([recordedAt])
  @@index([changeType])
  @@map("warehouse_history")
}

model Delivery {
  id             Int                 @id @default(autoincrement())
  deliveryDate   DateTime            @map("delivery_date")
  deliveryNumber String?             @map("delivery_number")
  status         String              @default("planned")
  notes          String?
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  deletedAt      DateTime?           @map("deleted_at")
  deliveryItems  DeliveryItem[]
  deliveryOrders DeliveryOrder[]
  optimization   PalletOptimization?

  @@index([status])
  @@index([deliveryDate])
  @@index([createdAt])
  @@index([deliveryDate, status])
  @@index([status, deliveryDate])
  @@index([deletedAt])
  @@map("deliveries")
}

model DeliveryOrder {
  id         Int      @id @default(autoincrement())
  deliveryId Int      @map("delivery_id")
  orderId    Int      @map("order_id")
  position   Int
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  delivery   Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@unique([deliveryId, orderId])
  @@map("delivery_orders")
}

model DeliveryItem {
  id          Int      @id @default(autoincrement())
  deliveryId  Int      @map("delivery_id")
  itemType    String   @map("item_type")
  description String
  quantity    Int
  createdAt   DateTime @default(now()) @map("created_at")
  delivery    Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@map("delivery_items")
}

model PalletType {
  id          Int      @id @default(autoincrement())
  name        String
  lengthMm    Int      @map("length_mm")
  loadDepthMm Int      @default(6000) @map("load_depth_mm")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("pallet_types")
}

model ProfileDepth {
  id          Int      @id @default(autoincrement())
  profileType String   @unique @map("profile_type")
  depthMm     Int      @map("depth_mm")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("profile_depths")
}

model PackingRule {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  ruleConfig  String   @map("rule_config")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("packing_rules")
}

model PalletOptimization {
  id               Int               @id @default(autoincrement())
  deliveryId       Int               @unique @map("delivery_id")
  totalPallets     Int               @map("total_pallets")
  optimizationData String            @map("optimization_data")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  pallets          OptimizedPallet[]
  delivery         Delivery          @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@map("pallet_optimizations")
}

model OptimizedPallet {
  id                 Int                @id @default(autoincrement())
  optimizationId     Int                @map("optimization_id")
  palletNumber       Int                @map("pallet_number")
  palletTypeName     String             @map("pallet_type_name")
  palletWidth        Int                @map("pallet_width")
  usedDepthMm        Int                @map("used_depth_mm")
  maxDepthMm         Int                @map("max_depth_mm")
  utilizationPercent Float              @map("utilization_percent")
  windowsData        String             @map("windows_data")
  optimization       PalletOptimization @relation(fields: [optimizationId], references: [id], onDelete: Cascade)

  @@index([optimizationId])
  @@map("optimized_pallets")
}

model FileImport {
  id                 Int                  @id @default(autoincrement())
  filename           String
  filepath           String
  fileType           String               @map("file_type")
  status             String               @default("pending")
  processedAt        DateTime?            @map("processed_at")
  errorMessage       String?              @map("error_message")
  metadata           String?
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  glassDeliveries    GlassDelivery[]
  pendingOrderPrices PendingOrderPrice[]

  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("file_imports")
}

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model Note {
  id          Int      @id @default(autoincrement())
  orderId     Int?     @map("order_id")
  content     String
  createdAt   DateTime @default(now()) @map("created_at")
  createdById Int?     @map("created_by_id")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   User?    @relation(fields: [createdById], references: [id])
  order       Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("notes")
}

model WorkingDay {
  id          Int      @id @default(autoincrement())
  date        DateTime @unique
  isWorking   Boolean  @default(true) @map("is_working")
  description String?
  isHoliday   Boolean  @default(false) @map("is_holiday")
  country     String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("working_days")
}

model SchucoDelivery {
  id                 Int               @id @default(autoincrement())
  orderDate          String            @map("order_date")
  orderNumber        String            @unique @map("order_number")
  projectNumber      String            @map("project_number")
  orderName          String            @map("order_name")
  shippingStatus     String            @map("shipping_status")
  deliveryWeek       String?           @map("delivery_week")
  deliveryType       String?           @map("delivery_type")
  tracking           String?
  complaint          String?
  orderType          String?           @map("order_type")
  totalAmount        String?           @map("total_amount")
  rawData            String?           @map("raw_data")
  fetchedAt          DateTime          @default(now()) @map("fetched_at")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  orderDateParsed    DateTime?         @map("order_date_parsed")
  changeType         String?           @map("change_type")
  changedAt          DateTime?         @map("changed_at")
  changedFields      String?           @map("changed_fields")
  previousValues     String?           @map("previous_values")
  isWarehouseItem    Boolean           @default(false) @map("is_warehouse_item")
  extractedOrderNums String?           @map("extracted_order_nums")
  orderLinks         OrderSchucoLink[]

  @@index([fetchedAt])
  @@index([orderNumber])
  @@index([orderDate])
  @@index([orderDateParsed])
  @@index([changeType])
  @@index([changedAt])
  @@index([changeType, changedAt])
  @@index([orderDateParsed, shippingStatus])
  @@index([shippingStatus, orderDateParsed])
  @@index([isWarehouseItem])
  @@index([orderNumber, fetchedAt])
  @@map("schuco_deliveries")
}

model SchucoFetchLog {
  id               Int       @id @default(autoincrement())
  status           String
  triggerType      String    @default("manual") @map("trigger_type")
  recordsCount     Int?      @map("records_count")
  newRecords       Int?      @map("new_records")
  updatedRecords   Int?      @map("updated_records")
  unchangedRecords Int?      @map("unchanged_records")
  errorMessage     String?   @map("error_message")
  startedAt        DateTime  @default(now()) @map("started_at")
  completedAt      DateTime? @map("completed_at")
  durationMs       Int?      @map("duration_ms")

  @@index([startedAt])
  @@index([triggerType])
  @@map("schuco_fetch_logs")
}

model MonthlyReport {
  id            Int                 @id @default(autoincrement())
  year          Int
  month         Int
  reportDate    DateTime            @default(now()) @map("report_date")
  totalOrders   Int                 @default(0) @map("total_orders")
  totalWindows  Int                 @default(0) @map("total_windows")
  totalSashes   Int                 @default(0) @map("total_sashes")
  totalValuePln Int                 @default(0) @map("total_value_pln")
  totalValueEur Int                 @default(0) @map("total_value_eur")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")
  reportItems   MonthlyReportItem[]

  @@unique([year, month])
  @@index([year, month])
  @@index([reportDate])
  @@map("monthly_reports")
}

model MonthlyReportItem {
  id            Int           @id @default(autoincrement())
  reportId      Int           @map("report_id")
  orderId       Int           @map("order_id")
  orderNumber   String        @map("order_number")
  invoiceNumber String?       @map("invoice_number")
  windowsCount  Int           @default(0) @map("windows_count")
  sashesCount   Int           @default(0) @map("sashes_count")
  unitsCount    Int           @default(0) @map("units_count")
  valuePln      Int?          @map("value_pln")
  valueEur      Int?          @map("value_eur")
  createdAt     DateTime      @default(now()) @map("created_at")
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Restrict)
  report        MonthlyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([orderId])
  @@map("monthly_report_items")
}

model CurrencyConfig {
  id            Int      @id @default(autoincrement())
  eurToPlnRate  Int      @map("eur_to_pln_rate")
  effectiveDate DateTime @default(now()) @map("effective_date")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([effectiveDate])
  @@map("currency_config")
}

model GlassDelivery {
  id                    Int                 @id @default(autoincrement())
  rackNumber            String              @map("rack_number")
  customerOrderNumber   String              @map("customer_order_number")
  supplierOrderNumber   String?             @map("supplier_order_number")
  deliveryDate          DateTime            @map("delivery_date")
  fileImportId          Int?                @map("file_import_id")
  createdAt             DateTime            @default(now()) @map("created_at")
  fileImport            FileImport?         @relation(fields: [fileImportId], references: [id])
  items                 GlassDeliveryItem[]

  @@index([deliveryDate])
  @@index([customerOrderNumber])
  @@index([rackNumber])
  @@map("glass_deliveries")
}

model GlassDeliveryItem {
  id               Int             @id @default(autoincrement())
  glassDeliveryId  Int             @map("glass_delivery_id")
  glassOrderId     Int?            @map("glass_order_id")
  orderNumber      String          @map("order_number")
  orderSuffix      String?         @map("order_suffix")
  position         String
  widthMm          Int             @map("width_mm")
  heightMm         Int             @map("height_mm")
  quantity         Int
  glassComposition String?         @map("glass_composition")
  serialNumber     String?         @map("serial_number")
  clientCode       String?         @map("client_code")
  matchStatus      String          @default("pending") @map("match_status")
  matchedItemId    Int?            @map("matched_item_id")
  createdAt        DateTime        @default(now()) @map("created_at")
  glassOrder       GlassOrder?     @relation(fields: [glassOrderId], references: [id], onDelete: SetNull)
  glassDelivery    GlassDelivery   @relation(fields: [glassDeliveryId], references: [id], onDelete: Cascade)

  @@unique([glassDeliveryId, position])
  @@index([widthMm, heightMm])
  @@index([matchStatus])
  @@index([orderNumber, orderSuffix])
  @@index([orderNumber])
  @@index([glassDeliveryId])
  @@map("glass_delivery_items")
}

model GlassOrderItem {
  id           Int        @id @default(autoincrement())
  glassOrderId Int        @map("glass_order_id")
  orderNumber  String     @map("order_number")
  orderSuffix  String?    @map("order_suffix")
  position     String
  glassType    String     @map("glass_type")
  widthMm      Int        @map("width_mm")
  heightMm     Int        @map("height_mm")
  quantity     Int
  createdAt    DateTime   @default(now()) @map("created_at")
  order        Order?     @relation(fields: [orderNumber], references: [orderNumber], onDelete: Cascade)
  glassOrder   GlassOrder @relation(fields: [glassOrderId], references: [id], onDelete: Cascade)

  @@unique([glassOrderId, position])
  @@index([widthMm, heightMm])
  @@index([orderNumber, orderSuffix])
  @@index([orderNumber])
  @@index([glassOrderId])
  @@map("glass_order_items")
}

model GlassOrderValidation {
  id                Int         @id @default(autoincrement())
  glassOrderId      Int?        @map("glass_order_id")
  orderNumber       String      @map("order_number")
  validationType    String      @map("validation_type")
  severity          String
  expectedQuantity  Int?        @map("expected_quantity")
  orderedQuantity   Int?        @map("ordered_quantity")
  deliveredQuantity Int?        @map("delivered_quantity")
  message           String
  details           String?
  resolved          Boolean     @default(false)
  resolvedAt        DateTime?   @map("resolved_at")
  resolvedBy        String?     @map("resolved_by")
  createdAt         DateTime    @default(now()) @map("created_at")
  glassOrder        GlassOrder? @relation(fields: [glassOrderId], references: [id], onDelete: Cascade)

  @@index([resolved])
  @@index([severity])
  @@index([orderNumber])
  @@index([glassOrderId])
  @@map("glass_order_validations")
}

model GlassOrder {
  id                   Int                    @id @default(autoincrement())
  glassOrderNumber     String                 @unique @map("glass_order_number")
  orderDate            DateTime               @map("order_date")
  supplier             String
  orderedBy            String?                @map("ordered_by")
  expectedDeliveryDate DateTime?              @map("expected_delivery_date")
  actualDeliveryDate   DateTime?              @map("actual_delivery_date")
  status               String                 @default("ordered")
  notes                String?
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  deletedAt            DateTime?              @map("deleted_at")
  deliveryItems        GlassDeliveryItem[]
  items                GlassOrderItem[]
  validationResults    GlassOrderValidation[]

  @@index([expectedDeliveryDate])
  @@index([status])
  @@index([orderDate])
  @@index([glassOrderNumber])
  @@index([deletedAt])
  @@map("glass_orders")
}

model OrderSchucoLink {
  id               Int            @id @default(autoincrement())
  orderId          Int            @map("order_id")
  schucoDeliveryId Int            @map("schuco_delivery_id")
  linkedAt         DateTime       @default(now()) @map("linked_at")
  linkedBy         String?        @map("linked_by")
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  schucoDelivery   SchucoDelivery @relation(fields: [schucoDeliveryId], references: [id], onDelete: Cascade)

  @@unique([orderId, schucoDeliveryId])
  @@index([orderId])
  @@index([schucoDeliveryId])
  @@map("order_schuco_links")
}

model UserFolderSettings {
  id              Int      @id @default(autoincrement())
  userId          Int?     @unique @map("user_id")
  importsBasePath String   @map("imports_base_path")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("user_folder_settings")
}

model ImportLock {
  id          Int      @id @default(autoincrement())
  folderPath  String   @unique @map("folder_path")
  userId      Int      @map("user_id")
  lockedAt    DateTime @default(now()) @map("locked_at")
  expiresAt   DateTime @map("expires_at")
  processId   String?  @map("process_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
  @@map("import_locks")
}

// Ceny profili oczekujące na powiązanie ze zleceniem
// Gdy importujemy PDF z ceną ale zlecenie jeszcze nie istnieje,
// zapisujemy tu cenę i automatycznie przypisujemy gdy zlecenie się pojawi
model PendingOrderPrice {
  id            Int      @id @default(autoincrement())
  orderNumber   String   @map("order_number")
  reference     String?
  currency      String   // EUR lub PLN
  valueNetto    Int      @map("value_netto")
  valueBrutto   Int?     @map("value_brutto")
  filename      String   // oryginalny nazwa pliku PDF
  filepath      String   // ścieżka do pliku
  importId      Int?     @map("import_id")
  status        String   @default("pending") // pending, applied, expired
  appliedAt     DateTime? @map("applied_at")
  appliedToOrderId Int?  @map("applied_to_order_id")
  expiresAt     DateTime? @map("expires_at") // optional TTL - when this record should be cleaned up
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  fileImport    FileImport? @relation(fields: [importId], references: [id], onDelete: SetNull)

  @@index([orderNumber])
  @@index([status])
  @@index([orderNumber, status])
  @@index([expiresAt])
  @@index([status, expiresAt])
  @@index([status, appliedAt])
  @@map("pending_order_prices")
}

// =============================================================================
// DUALSTOCK MODULE - Magazyn okuć (PVC + ALU)
// =============================================================================

// Artykuł okuciowy - podstawowa jednostka w systemie
model OkucArticle {
  id              Int      @id @default(autoincrement())
  articleId       String   @unique @map("article_id")  // Numer artykułu (np. "A123")
  name            String
  description     String?

  // Klasyfikacja
  usedInPvc       Boolean  @default(false) @map("used_in_pvc")
  usedInAlu       Boolean  @default(false) @map("used_in_alu")
  orderClass      String   @default("typical") @map("order_class")  // 'typical' | 'atypical'
  sizeClass       String   @default("standard") @map("size_class")  // 'standard' | 'gabarat'

  // Jednostki i opakowania
  orderUnit       String   @default("piece") @map("order_unit")  // 'piece' | 'pack'
  packagingSizes  String?  @map("packaging_sizes")  // JSON: [50, 100]
  preferredSize   Int?     @map("preferred_size")

  // Dane dostawcy
  supplierCode    String?  @map("supplier_code")
  leadTimeDays    Int      @default(14) @map("lead_time_days")
  safetyDays      Int      @default(3) @map("safety_days")

  // Audit
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relacje
  aliases            OkucArticleAlias[]
  proportionsSource  OkucProportion[]   @relation("SourceArticle")
  proportionsTarget  OkucProportion[]   @relation("TargetArticle")
  stocks             OkucStock[]
  demands            OkucDemand[]
  orderItems         OkucOrderItem[]
  historyEntries     OkucHistory[]

  @@index([usedInPvc])
  @@index([usedInAlu])
  @@index([orderClass, sizeClass])
  @@index([articleId])
  @@map("okuc_articles")
}

// System aliasów - mapowanie starych numerów na nowe
model OkucArticleAlias {
  id              Int           @id @default(autoincrement())
  articleId       Int           @map("article_id")
  aliasNumber     String        @unique @map("alias_number")  // Stary numer
  isActive        Boolean       @default(true) @map("is_active")  // false gdy zapas zszedł do 0
  deactivatedAt   DateTime?     @map("deactivated_at")
  createdAt       DateTime      @default(now()) @map("created_at")

  article         OkucArticle   @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([aliasNumber])
  @@index([isActive])
  @@index([articleId])
  @@map("okuc_article_aliases")
}

// Proporcje między artykułami (multiplier/split)
model OkucProportion {
  id              Int           @id @default(autoincrement())
  sourceArticleId Int           @map("source_article_id")
  targetArticleId Int           @map("target_article_id")
  proportionType  String        @map("proportion_type")  // 'multiplier' | 'split'
  ratio           Float         @default(1.0)  // np. 2.0 oznacza 2x target na 1x source
  splitPercent    Float?        @map("split_percent")  // dla typu 'split' (0-100)
  tolerance       Float         @default(0.9)  // tolerancja proporcji (np. 90%)
  isActive        Boolean       @default(true) @map("is_active")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  sourceArticle   OkucArticle   @relation("SourceArticle", fields: [sourceArticleId], references: [id], onDelete: Cascade)
  targetArticle   OkucArticle   @relation("TargetArticle", fields: [targetArticleId], references: [id], onDelete: Cascade)

  @@unique([sourceArticleId, targetArticleId])
  @@index([sourceArticleId])
  @@index([targetArticleId])
  @@index([isActive])
  @@map("okuc_proportions")
}

// Stan magazynowy okuć (PVC: 3 podmagazyny, ALU: jeden magazyn)
model OkucStock {
  id              Int           @id @default(autoincrement())
  articleId       Int           @map("article_id")
  warehouseType   String        @map("warehouse_type")  // 'pvc' | 'alu'
  subWarehouse    String?       @map("sub_warehouse")   // 'production' | 'buffer' | 'gabaraty' (tylko PVC)
  currentQuantity Int           @default(0) @map("current_quantity")
  reservedQty     Int           @default(0) @map("reserved_qty")
  minStock        Int?          @map("min_stock")
  maxStock        Int?          @map("max_stock")
  version         Int           @default(0)  // Optimistic locking
  updatedAt       DateTime      @updatedAt @map("updated_at")
  updatedById     Int?          @map("updated_by_id")

  article         OkucArticle   @relation(fields: [articleId], references: [id], onDelete: Restrict)
  updatedBy       User?         @relation("OkucStockUpdatedBy", fields: [updatedById], references: [id])

  @@unique([articleId, warehouseType, subWarehouse])
  @@index([warehouseType])
  @@index([subWarehouse])
  @@index([articleId])
  @@map("okuc_stocks")
}

// Zapotrzebowanie na okucia (z CSV lub zleceń)
model OkucDemand {
  id               Int           @id @default(autoincrement())
  demandId         String?       @unique @map("demand_id")  // ID z CSV importu (np. ZAP-2025-0089)
  articleId        Int           @map("article_id")
  orderId          Int?          @map("order_id")  // Powiązanie ze zleceniem (opcjonalne)
  expectedWeek     String        @map("expected_week")  // Format: "2025-W02"
  quantity         Int
  status           String        @default("pending")  // 'pending' | 'confirmed' | 'in_production' | 'completed' | 'cancelled'
  source           String        @default("order")  // 'order' | 'csv_import'

  // Audit edycji ręcznej
  isManualEdit     Boolean       @default(false) @map("is_manual_edit")
  editedAt         DateTime?     @map("edited_at")
  editedById       Int?          @map("edited_by_id")
  editReason       String?       @map("edit_reason")

  // Timestamps
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  article          OkucArticle   @relation(fields: [articleId], references: [id], onDelete: Restrict)
  order            Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([articleId])
  @@index([expectedWeek])
  @@index([status])
  @@index([orderId])
  @@index([source])
  @@index([expectedWeek, status])
  @@map("okuc_demands")
}

// Zamówienie do dostawcy okuć
model OkucOrder {
  id                   Int             @id @default(autoincrement())
  orderNumber          String          @unique @map("order_number")
  basketType           String          @map("basket_type")  // 'typical_standard' | 'typical_gabarat' | 'atypical'
  status               String          @default("draft")  // 'draft' | 'pending' | 'ordered' | 'in_transit' | 'received' | 'cancelled'
  expectedDeliveryDate DateTime?       @map("expected_delivery_date")
  actualDeliveryDate   DateTime?       @map("actual_delivery_date")
  notes                String?

  // Audit edycji ręcznej
  isManualEdit         Boolean         @default(false) @map("is_manual_edit")
  editedAt             DateTime?       @map("edited_at")
  editedById           Int?            @map("edited_by_id")
  editReason           String?         @map("edit_reason")

  // Timestamps
  createdAt            DateTime        @default(now()) @map("created_at")
  createdById          Int?            @map("created_by_id")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  items                OkucOrderItem[]
  createdBy            User?           @relation("OkucOrderCreatedBy", fields: [createdById], references: [id])

  @@index([basketType])
  @@index([status])
  @@index([expectedDeliveryDate])
  @@index([status, basketType])
  @@map("okuc_orders")
}

// Pozycja zamówienia okuć
model OkucOrderItem {
  id              Int           @id @default(autoincrement())
  okucOrderId     Int           @map("okuc_order_id")
  articleId       Int           @map("article_id")
  orderedQty      Int           @map("ordered_qty")
  receivedQty     Int?          @map("received_qty")
  unitPrice       Int?          @map("unit_price")  // Cena w groszach

  okucOrder       OkucOrder     @relation(fields: [okucOrderId], references: [id], onDelete: Cascade)
  article         OkucArticle   @relation(fields: [articleId], references: [id], onDelete: Restrict)

  @@unique([okucOrderId, articleId])
  @@index([okucOrderId])
  @@index([articleId])
  @@map("okuc_order_items")
}

// Historia zmian magazynowych okuć (RW, korekty, zwroty, remanent)
model OkucHistory {
  id              Int           @id @default(autoincrement())
  articleId       Int           @map("article_id")
  warehouseType   String        @map("warehouse_type")  // 'pvc' | 'alu'
  subWarehouse    String?       @map("sub_warehouse")
  eventType       String        @map("event_type")  // 'rw' | 'manual_consumption' | 'adjustment' | 'return' | 'inventory_count' | 'transfer' | 'order_received'
  previousQty     Int           @map("previous_qty")
  changeQty       Int           @map("change_qty")  // Może być ujemna
  newQty          Int           @map("new_qty")
  reason          String?       // Wymagane dla adjustment i manual_consumption
  reference       String?       // RW number, Order ID, itp.

  // Audit edycji ręcznej
  isManualEdit    Boolean       @default(false) @map("is_manual_edit")
  editedAt        DateTime?     @map("edited_at")
  editedById      Int?          @map("edited_by_id")

  // Timestamps
  recordedAt      DateTime      @default(now()) @map("recorded_at")
  recordedById    Int?          @map("recorded_by_id")

  article         OkucArticle   @relation(fields: [articleId], references: [id], onDelete: Restrict)
  recordedBy      User?         @relation("OkucHistoryRecordedBy", fields: [recordedById], references: [id])
  editedBy        User?         @relation("OkucHistoryEditedBy", fields: [editedById], references: [id])

  @@index([articleId])
  @@index([eventType])
  @@index([recordedAt])
  @@index([warehouseType])
  @@index([warehouseType, subWarehouse])
  @@index([isManualEdit])
  @@map("okuc_history")
}
